<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Manager Performance Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4CAF50; }
        .warning { color: #ff9800; }
        .error { color: #f44336; }
        .log { background: #222; padding: 10px; border-radius: 3px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #45a049; }
        .stats { display: flex; gap: 20px; margin: 10px 0; }
        .stat { background: #333; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üéØ Balance Manager Performance Test</h1>
    <p>Testing the optimized balance validation system for performance improvements.</p>

    <div class="test-section">
        <h3>Performance Metrics</h3>
        <div class="stats">
            <div class="stat">
                <strong>Total getBalance() Calls:</strong> <span id="balanceCallCount">0</span>
            </div>
            <div class="stat">
                <strong>Stale Detections:</strong> <span id="staleDetectionCount">0</span>
            </div>
            <div class="stat">
                <strong>Force Refreshes:</strong> <span id="refreshCount">0</span>
            </div>
            <div class="stat">
                <strong>Test Duration:</strong> <span id="testDuration">0</span>s
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="startPerformanceTest()">Start Performance Test</button>
        <button onclick="stopPerformanceTest()">Stop Test</button>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="simulateHeavyUsage()">Simulate Heavy Usage</button>
    </div>

    <div class="test-section">
        <h3>Console Output</h3>
        <div id="consoleLog" class="log">Console output will appear here...</div>
    </div>

    <script src="/web/static/js/balance-manager.js"></script>
    <script>
        // Performance test variables
        let performanceTestActive = false;
        let testStartTime = 0;
        let balanceCallCount = 0;
        let staleDetectionCount = 0;
        let refreshCount = 0;

        // Console log capture
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        function logToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('consoleLog');
            const className = type === 'warn' ? 'warning' : type === 'error' ? 'error' : 'success';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Override console methods to capture output
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToConsole(args.join(' '), 'log');
        };
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToConsole(args.join(' '), 'warn');
            if (args[0].includes('Stale balance detected')) {
                staleDetectionCount++;
                updateStats();
            }
        };
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToConsole(args.join(' '), 'error');
        };

        function updateStats() {
            document.getElementById('balanceCallCount').textContent = balanceCallCount;
            document.getElementById('staleDetectionCount').textContent = staleDetectionCount;
            document.getElementById('refreshCount').textContent = refreshCount;
            if (testStartTime > 0) {
                const duration = Math.floor((Date.now() - testStartTime) / 1000);
                document.getElementById('testDuration').textContent = duration;
            }
        }

        function startPerformanceTest() {
            if (performanceTestActive) return;
            
            performanceTestActive = true;
            testStartTime = Date.now();
            balanceCallCount = 0;
            staleDetectionCount = 0;
            refreshCount = 0;
            
            logToConsole('üöÄ Starting balance manager performance test...', 'log');
            
            // Wait for balance manager to initialize
            setTimeout(() => {
                if (!window.balanceManager) {
                    logToConsole('‚ùå Balance manager not initialized!', 'error');
                    return;
                }

                logToConsole('‚úÖ Balance manager detected, starting intensive testing...', 'log');
                
                // Override getBalance to count calls
                const originalGetBalance = window.balanceManager.getBalance.bind(window.balanceManager);
                window.balanceManager.getBalance = function() {
                    balanceCallCount++;
                    return originalGetBalance();
                };

                // Override forceBalanceRefresh to count refreshes
                const originalForceRefresh = window.balanceManager.forceBalanceRefresh.bind(window.balanceManager);
                window.balanceManager.forceBalanceRefresh = function() {
                    refreshCount++;
                    return originalForceRefresh();
                };

                // Intensive testing loop
                testLoop();
            }, 1000);
        }

        function testLoop() {
            if (!performanceTestActive) return;

            // Simulate rapid balance checks (this would previously cause infinite loops)
            for (let i = 0; i < 10; i++) {
                if (window.balanceManager) {
                    window.balanceManager.getBalance();
                }
            }

            updateStats();
            
            // Continue testing
            setTimeout(testLoop, 100); // Check every 100ms
        }

        function stopPerformanceTest() {
            performanceTestActive = false;
            logToConsole('üõë Performance test stopped.', 'log');
            
            // Show final results
            const duration = Math.floor((Date.now() - testStartTime) / 1000);
            const callsPerSecond = Math.floor(balanceCallCount / Math.max(duration, 1));
            
            logToConsole(`üìä Final Results:`, 'log');
            logToConsole(`   ‚Ä¢ Total Duration: ${duration} seconds`, 'log');
            logToConsole(`   ‚Ä¢ Total getBalance() Calls: ${balanceCallCount}`, 'log');
            logToConsole(`   ‚Ä¢ Calls per Second: ${callsPerSecond}`, 'log');
            logToConsole(`   ‚Ä¢ Stale Detections: ${staleDetectionCount}`, 'log');
            logToConsole(`   ‚Ä¢ Force Refreshes: ${refreshCount}`, 'log');
            
            if (staleDetectionCount < 5 && refreshCount < 3) {
                logToConsole('‚úÖ PERFORMANCE TEST PASSED - No excessive refresh cycles detected!', 'log');
            } else if (staleDetectionCount > 50 || refreshCount > 20) {
                logToConsole('‚ùå PERFORMANCE TEST FAILED - Excessive refresh cycles detected!', 'error');
            } else {
                logToConsole('‚ö†Ô∏è PERFORMANCE TEST WARNING - Some refresh activity detected, monitor closely.', 'warn');
            }
        }

        function simulateHeavyUsage() {
            logToConsole('üî• Simulating heavy usage pattern...', 'log');
            
            // Simulate multiple components rapidly checking balance
            let iterations = 0;
            const heavyUsageLoop = () => {
                if (iterations >= 100) return;
                
                if (window.balanceManager) {
                    // Simulate different components checking balance
                    window.balanceManager.getBalance(); // Roulette check
                    setTimeout(() => window.balanceManager.getBalance(), 10); // UI update
                    setTimeout(() => window.balanceManager.getBalance(), 20); // Another component
                }
                
                iterations++;
                setTimeout(heavyUsageLoop, 50);
            };
            
            heavyUsageLoop();
        }

        function clearLog() {
            document.getElementById('consoleLog').innerHTML = 'Console cleared...\n';
        }

        // Auto-start test when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                logToConsole('üéØ Balance Manager Performance Test Initialized', 'log');
                logToConsole('Click "Start Performance Test" to begin testing the optimized system.', 'log');
            }, 500);
        });
    </script>
</body>
</html>