{% extends "base.html" %}

{% block title %}Paper Trading - CryptoChecker Gaming Platform{% endblock %}

{% block extra_css %}
<link href="/static/css/trading-clean.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #2563eb;
        --success-color: #059669;
        --danger-color: #dc2626;
        --warning-color: #d97706;
    }

    .trading-header {
        background: linear-gradient(135deg, #1e3a8a, #3b82f6);
        color: white;
        padding: 2rem 0;
        position: relative;
        overflow: hidden;
    }

    .portfolio-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .positive { color: var(--success-color); }
    .negative { color: var(--danger-color); }
    .neutral { color: #6b7280; }

    .holding-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: white;
    }

    .trade-form {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .btn-buy {
        background-color: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    .btn-sell {
        background-color: var(--danger-color);
        border-color: var(--danger-color);
        color: white;
    }

    .transaction-item {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .loading {
        display: none;
    }

    .performance-chart {
        height: 300px;
        background: white;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }

    /* Additional trading-specific styles */
    .stat-visual {
        background: var(--stat-color-light, #f8fafc);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid var(--stat-color, #e2e8f0);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        background: var(--stat-color, #6366f1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.2rem;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--stat-color, #374151);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
</style>
{% endblock %}

{% block body_class %}trading-page{% endblock %}

{% block content %}
<!-- Enhanced Header with Glassmorphism -->
<div class="trading-header">
    <!-- Animated Background Pattern -->
    <div class="position-absolute w-100 h-100 pattern-dots" style="opacity: 0.1;"></div>
    
    <div class="container position-relative">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center animate-on-scroll" data-animation="fadeInUp">
                    <div class="logo-icon me-3" style="font-size: 3rem; color: #fbbf24;">
                        ₿
                    </div>
                    <div>
                        <h1 class="mb-0">
                            Paper Trading Dashboard
                        </h1>
                        <p class="mb-0 mt-2 opacity-75">Practice trading with virtual money • Risk-free learning environment</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-light" onclick="refreshDashboard()" id="refresh-btn">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <div id="effects-badge" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container my-4">
    
    <!-- Enhanced Loading Indicator -->
    <div class="text-center my-5 loading" id="main-loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 fw-semibold">Loading portfolio data...</p>
    </div>

    <!-- Enhanced Portfolio Overview -->
    <div class="row mb-4" id="portfolio-overview" style="display: none;">
        <div class="col-12">
            <div class="portfolio-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--primary-color);"></i>
                        </div>
                        <div>
                            <h3 class="mb-0">Demo Trading Portfolio</h3>
                            <p class="mb-0 text-muted">Virtual trading environment</p>
                        </div>
                    </div>
                    <span class="badge bg-success" style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">
                        <i class="fas fa-circle me-2" style="font-size: 0.6rem;"></i>Active
                    </span>
                </div>
                
                <div class="row">
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stat-visual" style="--stat-color: #4f46e5; --stat-color-light: #eef2ff;">
                            <div class="stat-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="stat-value" id="portfolio-value">$0.00</div>
                            <div class="stat-label">Portfolio Value</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stat-visual" style="--stat-color: #10b981; --stat-color-light: #ecfdf5;">
                            <div class="stat-icon">
                                <i class="fas fa-trending-up"></i>
                            </div>
                            <div class="stat-value" id="total-return">$0.00</div>
                            <div class="stat-label">Total Return</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stat-visual" style="--stat-color: #f59e0b; --stat-color-light: #fffbeb;">
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value" id="return-percentage">0.00%</div>
                            <div class="stat-label">Return %</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stat-visual" style="--stat-color: #8b5cf6; --stat-color-light: #f5f3ff;">
                            <div class="stat-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="stat-value" id="available-cash">$10,000</div>
                            <div class="stat-label">Available Cash</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stat-visual" style="--stat-color: #ef4444; --stat-color-light: #fef2f2;">
                            <div class="stat-icon">
                                <i class="fas fa-gem"></i>
                            </div>
                            <div class="stat-value" id="gem-balance">0</div>
                            <div class="stat-label">GEM Coins</div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6 mb-3">
                        <div class="stat-visual" style="--stat-color: #06b6d4; --stat-color-light: #ecfeff;">
                            <div class="stat-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="stat-value" id="open-positions">0</div>
                            <div class="stat-label">Open Positions</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row">
        <!-- Left Column: Holdings, Orders, Transactions -->
        <div class="col-lg-8">
            
            <!-- Holdings Section -->
            <div class="portfolio-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-briefcase me-2"></i>Current Holdings</h4>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshHoldings()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="holdings-container">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3 opacity-50"></i>
                        <p>No holdings yet. Start trading to see your positions here.</p>
                    </div>
                </div>
            </div>

            <!-- Open Orders Section -->
            <div class="portfolio-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-list-ul me-2"></i>Open Orders</h4>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="orders-container">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-clock fa-3x mb-3 opacity-50"></i>
                        <p>No open orders. Place a limit order to see it here.</p>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="portfolio-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-history me-2"></i>Recent Transactions</h4>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshTransactions()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="transactions-container">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-exchange-alt fa-3x mb-3 opacity-50"></i>
                        <p>No transactions yet. Your trading history will appear here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Trading Panel -->
        <div class="col-lg-4">
            <!-- Quick Trade Form -->
            <div class="trade-form mb-4">
                <h4 class="mb-3"><i class="fas fa-bolt me-2"></i>Quick Trade</h4>
                
                <form id="quick-trade-form">
                    <div class="mb-3">
                        <label class="form-label">Cryptocurrency</label>
                        <select class="form-select" id="coin-select">
                            <option value="bitcoin">Bitcoin (BTC)</option>
                            <option value="ethereum">Ethereum (ETH)</option>
                            <option value="cardano">Cardano (ADA)</option>
                            <option value="solana">Solana (SOL)</option>
                            <option value="polkadot">Polkadot (DOT)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Current Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="current-price" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="updatePrice()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Order Type</label>
                        <select class="form-select" id="order-type">
                            <option value="MARKET">Market Order</option>
                            <option value="LIMIT">Limit Order</option>
                            <option value="STOP_LOSS">Stop Loss</option>
                            <option value="TAKE_PROFIT">Take Profit</option>
                        </select>
                    </div>

                    <div class="mb-3" id="limit-price-group" style="display: none;">
                        <label class="form-label">Limit Price</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="limit-price" step="0.01">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Amount (USD)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="trade-amount" min="1" step="0.01" value="100">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <button type="button" class="btn btn-buy w-100" onclick="executeTrade('BUY')">
                                <i class="fas fa-arrow-up me-2"></i>Buy
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-sell w-100" onclick="executeTrade('SELL')">
                                <i class="fas fa-arrow-down me-2"></i>Sell
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- GEM Wallet Integration -->
            <div class="portfolio-card mb-4">
                <h5><i class="fas fa-gem me-2 text-warning"></i>GEM Wallet</h5>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Balance:</span>
                    <span class="fw-bold" id="wallet-gem-balance">0 GEM</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted">USD Value:</small>
                    <small class="text-muted" id="wallet-usd-value">$0.00</small>
                </div>
                <div class="row">
                    <div class="col-6">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="convertUSDToGEM()">
                            <i class="fas fa-coins me-1"></i>Buy GEM
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-warning btn-sm w-100" onclick="convertGEMToUSD()">
                            <i class="fas fa-dollar-sign me-1"></i>Sell GEM
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Effects -->
            <div class="portfolio-card" id="active-effects-panel" style="display: none;">
                <h5><i class="fas fa-magic me-2"></i>Active Effects</h5>
                <div id="active-effects-list">
                    <!-- Active consumable effects will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/trading.js"></script>
<script>
// Trading-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize trading dashboard
    initializeTradingDashboard();
    
    // Order type change handler
    document.getElementById('order-type').addEventListener('change', function() {
        const limitPriceGroup = document.getElementById('limit-price-group');
        if (this.value === 'LIMIT' || this.value === 'STOP_LOSS' || this.value === 'TAKE_PROFIT') {
            limitPriceGroup.style.display = 'block';
        } else {
            limitPriceGroup.style.display = 'none';
        }
    });
    
    // Auto-update prices every 30 seconds
    setInterval(updatePrice, 30000);
    updatePrice(); // Initial price fetch
});

async function initializeTradingDashboard() {
    try {
        // Show loading
        document.getElementById('main-loading').style.display = 'block';
        
        // Load portfolio data
        await loadPortfolioData();
        await loadHoldings();
        await loadOrders();
        await loadTransactions();
        await updateGEMWallet();
        
        // Hide loading and show content
        document.getElementById('main-loading').style.display = 'none';
        document.getElementById('portfolio-overview').style.display = 'block';
        
    } catch (error) {
        console.error('Failed to initialize trading dashboard:', error);
        showAlert('Failed to load trading dashboard', 'error');
    }
}

async function loadPortfolioData() {
    try {
        const response = await fetch('/api/trading/portfolio/demo/summary');
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
                updatePortfolioStats(data.data);
            }
        }
    } catch (error) {
        console.error('Failed to load portfolio data:', error);
    }
}

function updatePortfolioStats(data) {
    document.getElementById('portfolio-value').textContent = `$${(data.portfolio_value || 0).toFixed(2)}`;
    document.getElementById('total-return').textContent = `$${(data.total_return || 0).toFixed(2)}`;
    document.getElementById('return-percentage').textContent = `${(data.return_percentage || 0).toFixed(2)}%`;
    document.getElementById('available-cash').textContent = `$${(data.available_cash || 10000).toFixed(2)}`;
    document.getElementById('open-positions').textContent = data.open_positions || 0;
}

async function updatePrice() {
    const coinSelect = document.getElementById('coin-select');
    const currentPriceInput = document.getElementById('current-price');
    const selectedCoin = coinSelect.value;
    
    try {
        const response = await fetch(`/api/trading/prices?ids=${selectedCoin}`);
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success' && data.data[selectedCoin]) {
                currentPriceInput.value = data.data[selectedCoin].price.toFixed(2);
            }
        }
    } catch (error) {
        console.error('Failed to update price:', error);
    }
}

async function executeTrade(action) {
    const coinId = document.getElementById('coin-select').value;
    const amount = document.getElementById('trade-amount').value;
    const orderType = document.getElementById('order-type').value;
    
    if (!amount || amount <= 0) {
        showAlert('Please enter a valid amount', 'error');
        return;
    }
    
    try {
        let url, requestData;
        
        if (orderType === 'MARKET') {
            // Market order - quick trade
            url = `/api/trading/quick-trade/${action.toLowerCase()}/${coinId}?amount=${amount}`;
            const response = await fetch(url, { method: 'GET' });
            
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'success') {
                    showAlert(`${action} order executed successfully!`, 'success');
                    await loadPortfolioData();
                    await loadHoldings();
                    await loadTransactions();
                    await updateGEMWallet();
                } else {
                    showAlert(data.message || 'Trade failed', 'error');
                }
            }
        } else {
            // Limit/Stop orders
            const limitPrice = document.getElementById('limit-price').value;
            if (!limitPrice) {
                showAlert('Please enter a limit price', 'error');
                return;
            }
            
            requestData = {
                side: action,
                type: orderType,
                coin_id: coinId,
                quantity: parseFloat(amount) / parseFloat(limitPrice),
                price: parseFloat(limitPrice)
            };
            
            const response = await fetch('/api/trading/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'success') {
                    showAlert(`${orderType} order placed successfully!`, 'success');
                    await loadOrders();
                } else {
                    showAlert(data.message || 'Order failed', 'error');
                }
            }
        }
    } catch (error) {
        console.error('Trade execution failed:', error);
        showAlert('Trade execution failed', 'error');
    }
}

async function loadHoldings() {
    // Implementation for loading holdings
    console.log('Loading holdings...');
}

async function loadOrders() {
    // Implementation for loading open orders
    console.log('Loading orders...');
}

async function loadTransactions() {
    // Implementation for loading transaction history
    console.log('Loading transactions...');
}

async function updateGEMWallet() {
    try {
        const response = await fetch('/api/trading/gamification/wallet');
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
                const gemBalance = data.data.gem_coins;
                document.getElementById('gem-balance').textContent = gemBalance;
                document.getElementById('wallet-gem-balance').textContent = `${gemBalance} GEM`;
                // Assuming 1 GEM = $0.01 (can be made configurable)
                const usdValue = (gemBalance * 0.01).toFixed(2);
                document.getElementById('wallet-usd-value').textContent = `$${usdValue}`;
            }
        }
    } catch (error) {
        console.error('Failed to update GEM wallet:', error);
    }
}

function refreshDashboard() {
    initializeTradingDashboard();
}

function refreshHoldings() {
    loadHoldings();
}

function refreshOrders() {
    loadOrders();
}

function refreshTransactions() {
    loadTransactions();
}

function convertUSDToGEM() {
    // Implementation for USD to GEM conversion
    showAlert('GEM conversion feature coming soon!', 'info');
}

function convertGEMToUSD() {
    // Implementation for GEM to USD conversion
    showAlert('GEM conversion feature coming soon!', 'info');
}

function showAlert(message, type = 'info') {
    const alertContainer = document.getElementById('alertContainer');
    const alertHtml = `
        <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alertHtml;
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}