{% extends "base.html" %}

{% block title %}Profile - CryptoChecker Gaming Platform{% endblock %}

{% block extra_css %}
<style>
.profile-card {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    backdrop-filter: blur(12px);
}
.profile-avatar {
    width: 96px; height: 96px; border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.3);
}
.stat-pill {
    border-radius: 12px; padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="profile-card p-4">
                <div class="d-flex align-items-center mb-4">
                    <img id="profile-avatar" src="/static/images/default-avatar.png" class="profile-avatar me-3" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2796%27 height=%2796%27%3E%3Crect width=%2796%27 height=%2796%27 rx=%2716%27 fill=%27%23222%27/%3E%3C/svg%3E'">
                    <div>
                        <h2 class="text-white mb-1" id="profile-username">Guest</h2>
                        <div class="text-muted" id="profile-email">guest@example.com</div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="stat-pill text-white d-flex align-items-center justify-content-center">
                            <i class="fas fa-gem text-warning me-2"></i>
                            <span id="walletBalance">0</span> GEM
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-pill text-white d-flex align-items-center justify-content-center">
                            <i class="fas fa-star text-success me-2"></i>
                            <span id="profile-level">1</span> Level
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="stat-pill text-white d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-info me-2"></i>
                            <span id="profile-last-login">â€”</span>
                        </div>
                    </div>
                </div>

                <!-- Edit Profile Form -->
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label text-white-50">Display Name</label>
                        <input id="profile-display-name" class="form-control" placeholder="Your display name">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50">Email</label>
                        <input id="profile-email-input" class="form-control" disabled>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-white-50">Bio</label>
                        <textarea id="profile-bio" class="form-control" rows="3" placeholder="Tell others about yourself"></textarea>
                    </div>
                    <div class="col-12 d-flex gap-2">
                        <button class="btn btn-primary" id="save-profile-btn"><i class="fas fa-save me-2"></i>Save Profile</button>
                        <label class="btn btn-outline-light mb-0" for="avatar-input"><i class="fas fa-image me-2"></i>Change Avatar</label>
                        <input id="avatar-input" type="file" accept="image/*" class="d-none">
                        <button class="btn btn-outline-danger" id="remove-avatar-btn"><i class="fas fa-trash me-2"></i>Remove Avatar</button>
                    </div>
                    <div id="profile-alert" class="text-white-50 mt-2" style="min-height: 1.5rem;"></div>
                    <div class="col-12 mt-2">
                        <button class="btn btn-sm btn-outline-secondary" id="clear-cache-btn">
                            <i class="fas fa-broom me-2"></i>Clear Local Cache
                        </button>
                        <small class="text-muted ms-2">(Does not delete your profile data)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
    try {
        // Fetch auth info
        const me = await fetch('/api/auth/me');
        const meData = me.ok ? await me.json() : { status: 'error' };

        if (meData.status !== 'success' || !meData.user) {
            // Not logged in: send to login
            window.location.href = '/login';
            return;
        }

        const user = meData.user || {};
        document.getElementById('profile-username').textContent = user.username || 'Player';
        document.getElementById('profile-email').textContent = user.email || '';
        document.getElementById('profile-email-input').value = user.email || '';
        document.getElementById('profile-display-name').value = user.display_name || user.username || '';
        if (user.bio) document.getElementById('profile-bio').value = user.bio;

        // Avatar if available via session-aware endpoint later; use default for now
        if (user.avatar_url) {
            document.getElementById('profile-avatar').src = user.avatar_url;
        }

        // Level placeholder if present on mock user
        if (user.current_level) {
            document.getElementById('profile-level').textContent = user.current_level;
        }

        // Last login placeholder
        const lastLogin = user.last_login || '';
        if (lastLogin) {
            document.getElementById('profile-last-login').textContent = lastLogin;
        }

        // Load wallet balance into page stat and navbar
        if (window.auth) {
            await window.auth.loadWalletBalance();
        } else {
            const r = await fetch('/api/trading/gamification/wallet');
            if (r.ok) {
                const d = await r.json();
                if (d.status === 'success') {
                    const bal = d.data.gem_coins;
                    const el = document.getElementById('walletBalance');
                    if (el) el.textContent = (bal || 0).toLocaleString();
                    const nav = document.getElementById('nav-gem-balance');
                    if (nav) nav.textContent = (bal || 0).toLocaleString();
                }
            }
        }
        // Wire up edit/save actions
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            try {
                const display_name = document.getElementById('profile-display-name').value.trim();
                const bio = document.getElementById('profile-bio').value.trim();
                const r = await fetch('/api/profile/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ display_name, bio })
                });
                const d = await r.json();
                const alertEl = document.getElementById('profile-alert');
                if (d.status === 'success') {
                    alertEl.textContent = 'Profile saved successfully';
                    if (window.auth && window.auth.user) {
                        window.auth.user.username = user.username; // unchanged
                        window.auth.user.display_name = display_name || user.username;
                        window.auth.updateUI();
                    }
                } else {
                    alertEl.textContent = d.message || 'Failed to save profile';
                }
            } catch (err) {
                document.getElementById('profile-alert').textContent = 'Failed to save profile';
            }
        });

        document.getElementById('avatar-input').addEventListener('change', async (ev) => {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            try {
                const fd = new FormData();
                fd.append('avatar', file);
                const r = await fetch('/api/profile/avatar', { method: 'POST', body: fd });
                const d = await r.json();
                if (d.status === 'success' && d.avatar_url) {
                    document.getElementById('profile-avatar').src = d.avatar_url;
                    // Update nav avatar as well
                    const navImg = document.querySelector('#user-menu img');
                    if (navImg) navImg.src = d.avatar_url;
                    if (window.auth) {
                        window.auth.user = window.auth.user || {};
                        window.auth.user.avatar_url = d.avatar_url;
                        window.auth.updateUI();
                    }
                    document.getElementById('profile-alert').textContent = 'Avatar updated';
                } else {
                    document.getElementById('profile-alert').textContent = d.message || 'Failed to update avatar';
                }
            } catch (err) {
                document.getElementById('profile-alert').textContent = 'Failed to update avatar';
            }
        });

        document.getElementById('remove-avatar-btn').addEventListener('click', async () => {
            try {
                const r = await fetch('/api/profile/avatar/remove', { method: 'POST' });
                const d = await r.json();
                if (d.status === 'success') {
                    const url = d.avatar_url || '/static/images/default-avatar.png';
                    document.getElementById('profile-avatar').src = url;
                    const navImg = document.querySelector('#user-menu img');
                    if (navImg) navImg.src = url;
                    if (window.auth) {
                        window.auth.user = window.auth.user || {};
                        window.auth.user.avatar_url = url;
                        window.auth.updateUI();
                    }
                    document.getElementById('profile-alert').textContent = 'Avatar removed';
                } else {
                    document.getElementById('profile-alert').textContent = d.message || 'Failed to remove avatar';
                }
            } catch (err) {
                document.getElementById('profile-alert').textContent = 'Failed to remove avatar';
            }
        });

        document.getElementById('clear-cache-btn').addEventListener('click', () => {
            try {
                localStorage.clear();
                sessionStorage.clear();
                document.getElementById('profile-alert').textContent = 'Local cache cleared. Reloading...';
                setTimeout(() => window.location.reload(), 600);
            } catch (e) {
                document.getElementById('profile-alert').textContent = 'Failed to clear cache.';
            }
        });

    } catch (e) {
        console.error('Profile init failed:', e);
    }
});
</script>
{% endblock %}
