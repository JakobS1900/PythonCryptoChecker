{% extends "base.html" %}

{% block title %}Profile - CryptoChecker v3{% endblock %}

{% block extra_css %}
<style>
.profile-card {
    color: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

/* Profile theme gradients */
.profile-card.theme-purple {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.profile-card.theme-blue {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}
.profile-card.theme-green {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}
.profile-card.theme-orange {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}
.profile-card.theme-red {
    background: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
}
.profile-card.theme-pink {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
}
.profile-card.theme-dark {
    background: linear-gradient(135deg, #232526 0%, #414345 100%);
}
.profile-card.theme-ocean {
    background: linear-gradient(135deg, #2e3192 0%, #1bffff 100%);
}

.stat-card {
    transition: transform 0.3s ease;
    border: none;
    border-radius: 10px;
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.gem-balance {
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.transaction-row {
    border-bottom: 1px solid #eee;
    padding: 10px 0;
}

.transaction-row:last-child {
    border-bottom: none;
}

.profit {
    color: #28a745;
}

.loss {
    color: #dc3545;
}

.loading-spinner {
    display: none;
}

.portfolio-item {
    border-left: 4px solid transparent;
    transition: all 0.3s ease;
}

.portfolio-item.profit {
    border-left-color: #28a745;
    background-color: #f8fff9;
}

.portfolio-item.loss {
    border-left-color: #dc3545;
    background-color: #fff8f8;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Profile Header -->
    <div class="col-12 mb-4">
        <div class="card profile-card">
            <div class="card-body text-center p-4">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="position-relative d-inline-block">
                            <img id="profile-avatar" src="/static/img/default-avatar.png"
                                 alt="Profile Avatar"
                                 style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid rgba(255,255,255,0.3);"
                                 onerror="this.src='https://ui-avatars.com/api/?name=User&size=120&background=667eea&color=fff'">
                            <button class="btn btn-sm btn-light position-absolute"
                                    style="bottom: 0; right: 0; border-radius: 50%; width: 36px; height: 36px; padding: 0;"
                                    onclick="document.getElementById('avatar-input').click()"
                                    title="Change Avatar">
                                <i class="bi bi-camera"></i>
                            </button>
                            <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="Profile.handleAvatarUpload(event)">
                        </div>
                        <h3 class="mt-3" id="profile-username">Loading...</h3>
                        <span class="badge bg-light text-dark" id="profile-role">Player</span>
                        <button class="btn btn-sm btn-outline-light ms-2" onclick="Profile.showEditModal()">
                            <i class="bi bi-pencil"></i> Edit Profile
                        </button>
                    </div>
                    <div class="col-md-4">
                        <h2>GEM Balance</h2>
                        <div class="gem-balance" id="profile-gem-balance">
                            <div class="loading-spinner">
                                <div class="spinner-border text-light" role="status"></div>
                            </div>
                            <span id="balance-amount">0</span> üíé
                        </div>
                        <small class="text-light" id="balance-usd">$0.00 USD</small>
                    </div>
                    <div class="col-md-4">
                        <h5>Member Since</h5>
                        <p id="profile-join-date">Loading...</p>
                        <h5>Last Login</h5>
                        <p id="profile-last-login">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-graph-up text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="stat-total-winnings">0</h3>
                <small class="text-muted">Total Winnings (GEM)</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-dice-5 text-primary" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="stat-total-games">0</h3>
                <small class="text-muted">Total Games</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-trophy text-warning" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="stat-win-rate">0%</h3>
                <small class="text-muted">Win Rate</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="bi bi-wallet2 text-info" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="stat-portfolio-value">0</h3>
                <small class="text-muted">Portfolio Value (GEM)</small>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="portfolio-tab" data-bs-toggle="tab"
                                data-bs-target="#portfolio-pane" type="button" role="tab">
                            <i class="bi bi-wallet2"></i> Crypto Portfolio
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab"
                                data-bs-target="#transactions-pane" type="button" role="tab">
                            <i class="bi bi-list-ul"></i> Transaction History
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                                data-bs-target="#settings-pane" type="button" role="tab">
                            <i class="bi bi-gear"></i> Settings
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Portfolio Tab -->
                    <div class="tab-pane fade show active" id="portfolio-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Your Cryptocurrency Holdings</h5>
                            <button class="btn btn-success btn-sm" onclick="Profile.refreshPortfolio()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>

                        <div id="portfolio-content">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Loading portfolio...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Tab -->
                    <div class="tab-pane fade" id="transactions-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Recent Transactions</h5>
                            <button class="btn btn-primary btn-sm" onclick="Profile.refreshTransactions()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>

                        <div id="transactions-content">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">Loading transactions...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane fade" id="settings-pane" role="tabpanel">
                        <h5>Account Settings</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Balance Persistence Test</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Test if your GEM balance persists across sessions.</p>
                                        <button class="btn btn-primary" onclick="Profile.testBalancePersistence()">
                                            <i class="bi bi-check-circle"></i> Test Balance Persistence
                                        </button>
                                        <div id="persistence-result" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Account Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>GEM Rate:</strong> 1,000 GEM = $10.00 USD</p>
                                        <p><strong>Trading Fee:</strong> 1% per transaction</p>
                                        <p><strong>Supported Cryptos:</strong> 57+ cryptocurrencies</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-3">
                        <label for="edit-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="edit-username" required minlength="3" maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label for="edit-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-bio" class="form-label">Bio</label>
                        <textarea class="form-control" id="edit-bio" rows="3" maxlength="500"></textarea>
                        <small class="text-muted">Tell us about yourself (max 500 characters)</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit-avatar-url" class="form-label">Avatar URL</label>
                        <input type="url" class="form-control" id="edit-avatar-url" placeholder="https://...">
                        <small class="text-muted">Or use the camera button above to upload an image</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit-theme" class="form-label">Profile Theme</label>
                        <select class="form-select" id="edit-theme">
                            <option value="purple">Purple Haze</option>
                            <option value="blue">Ocean Blue</option>
                            <option value="green">Emerald Green</option>
                            <option value="orange">Sunset Orange</option>
                            <option value="red">Fire Red</option>
                            <option value="pink">Cherry Blossom</option>
                            <option value="dark">Dark Knight</option>
                            <option value="ocean">Deep Ocean</option>
                        </select>
                        <small class="text-muted">Choose your profile card color theme</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="Profile.saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Profile management module
window.Profile = {
    userStats: null,

    async init() {
        console.log('Profile module initialized');
        await this.loadUserProfile();
        await this.loadPortfolio();
        await this.loadTransactions();
    },

    async loadUserProfile() {
        try {
            console.log('üîÑ Loading user profile...');

            // Use auth/status endpoint which guarantees balance information
            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/auth/status', {
                method: 'GET',
                headers: headers,
                credentials: 'include'
            });

            if (response.ok) {
                const authStatus = await response.json();
                console.log('Auth status response:', authStatus);

                // Transform auth status to profile stats structure
                let profileData;
                if (authStatus.authenticated && authStatus.user) {
                    profileData = {
                        success: true,
                        wallet: {
                            gem_balance: authStatus.user.wallet_balance || 0
                        },
                        stats: {
                            gem_value_usd: (authStatus.user.wallet_balance || 0) * 0.01, // 1 GEM = 0.01 USD
                            total_winnings: 0, // Will be updated by portfolio load
                            total_games: 0,
                            win_rate: 0
                        },
                        user: {
                            username: authStatus.user.username,
                            email: authStatus.user.email,
                            role: authStatus.user.role,
                            created_at: authStatus.user.created_at,
                            last_login: authStatus.user.last_login
                        }
                    };
                } else if (authStatus.guest_mode && authStatus.guest_user) {
                    profileData = {
                        success: true,
                        wallet: {
                            gem_balance: authStatus.guest_user.wallet_balance || 5000
                        },
                        stats: {
                            gem_value_usd: (authStatus.guest_user.wallet_balance || 5000) * 0.01,
                            total_winnings: 0,
                            total_games: 0,
                            win_rate: 0
                        },
                        user: {
                            username: authStatus.guest_user.username,
                            email: authStatus.guest_user.email,
                            role: authStatus.guest_user.role,
                            created_at: authStatus.guest_user.created_at
                        }
                    };
                }

                if (profileData) {
                    this.userStats = profileData;
                    this.updateProfileUI();
                    console.log('‚úÖ Profile loaded successfully:', profileData);
                } else {
                    console.error('‚ùå Could not create profile data from auth status');
                    this.showErrorState();
                }
            } else {
                console.error('‚ùå Auth status request failed:', response.status);
                this.showErrorState();
            }
        } catch (error) {
            console.error('‚ùå Error loading profile:', error);
            this.showErrorState();
        }
    },

    async waitForApp(maxRetries = 50) {
        for (let i = 0; i < maxRetries; i++) {
            if (window.App && window.App.api) {
                return true;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        throw new Error('App object not available after waiting');
    },

    showErrorState() {
        // Show error state for profile loading
        document.getElementById('balance-amount').textContent = 'Error';
        document.getElementById('balance-usd').textContent = 'Error loading balance';
        App.showAlert('danger', 'Failed to load profile data. Please refresh the page.');
    },

    updateProfileUI() {
        if (!this.userStats) return;

        const { wallet, stats, user } = this.userStats;

        // Update profile header
        document.getElementById('profile-username').textContent = user.username || 'CryptoTrader';
        document.getElementById('profile-role').textContent = user.role || 'Player';

        // Update avatar
        const avatarImg = document.getElementById('profile-avatar');
        if (user.avatar_url) {
            avatarImg.src = user.avatar_url;
        } else {
            // Use UI Avatars as fallback with username
            avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username || 'User')}&size=120&background=667eea&color=fff`;
        }

        // Apply profile theme
        const profileCard = document.querySelector('.profile-card');
        const theme = user.profile_theme || 'purple';
        profileCard.className = `card profile-card theme-${theme}`;

        // Update dates
        if (user.created_at) {
            document.getElementById('profile-join-date').textContent = new Date(user.created_at).toLocaleDateString();
        }
        if (user.last_login) {
            document.getElementById('profile-last-login').textContent = new Date(user.last_login).toLocaleString();
        } else {
            document.getElementById('profile-last-login').textContent = 'First login';
        }

        document.getElementById('balance-amount').textContent = (wallet.gem_balance || 0).toFixed(2);
        document.getElementById('balance-usd').textContent = `$${(stats.gem_value_usd || 0).toFixed(2)} USD`;

        // Update stats cards
        document.getElementById('stat-total-winnings').textContent = (wallet.total_won || 0).toFixed(2);
        document.getElementById('stat-total-games').textContent = stats.total_games || 0;
        document.getElementById('stat-win-rate').textContent = `${stats.win_rate || 0}%`;
        document.getElementById('stat-portfolio-value').textContent = '0.00'; // Will be updated by portfolio
    },

    async loadPortfolio() {
        try {
            // Use direct fetch instead of App.api
            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/crypto/portfolio', {
                method: 'GET',
                headers: headers,
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Portfolio API response:', data);
                if (data.success) {
                    this.displayPortfolio(data.portfolio);
                    // Update portfolio value in stats
                    const portfolioValue = data.portfolio?.total_value_gem || 0;
                    document.getElementById('stat-portfolio-value').textContent = portfolioValue.toFixed(2);
                } else {
                    console.error('Portfolio API returned error:', data);
                    this.showPortfolioError();
                }
            } else {
                console.error('Portfolio API request failed:', response.status);
                this.showPortfolioError();
            }
        } catch (error) {
            console.error('Error loading portfolio:', error);
            this.showPortfolioError();
        }
    },

    showPortfolioError() {
        document.getElementById('portfolio-content').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No portfolio data available. Start trading to build your crypto portfolio!
            </div>
        `;
    },

    displayPortfolio(portfolioData) {
        const container = document.getElementById('portfolio-content');

        if (!portfolioData.holdings || portfolioData.holdings.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-wallet text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No crypto holdings yet</h5>
                    <p class="text-muted">Start trading to build your portfolio!</p>
                    <a href="/portfolio" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Start Trading
                    </a>
                </div>
            `;
            return;
        }

        let html = `
            <div class="row mb-3">
                <div class="col-md-3">
                    <strong>Total Value:</strong> ${portfolioData.total_value_gem.toFixed(2)} GEM
                </div>
                <div class="col-md-3">
                    <strong>Total Invested:</strong> ${portfolioData.total_invested_gem.toFixed(2)} GEM
                </div>
                <div class="col-md-3">
                    <strong>P&L:</strong>
                    <span class="${portfolioData.total_profit_loss_gem >= 0 ? 'profit' : 'loss'}">
                        ${portfolioData.total_profit_loss_gem >= 0 ? '+' : ''}${portfolioData.total_profit_loss_gem.toFixed(2)} GEM
                    </span>
                </div>
                <div class="col-md-3">
                    <strong>P&L %:</strong>
                    <span class="${portfolioData.total_profit_loss_percentage >= 0 ? 'profit' : 'loss'}">
                        ${portfolioData.total_profit_loss_percentage >= 0 ? '+' : ''}${portfolioData.total_profit_loss_percentage.toFixed(2)}%
                    </span>
                </div>
            </div>
            <hr>
        `;

        portfolioData.holdings.forEach(holding => {
            const crypto = holding.cryptocurrency;
            const isProfit = holding.profit_loss_gem >= 0;

            html += `
                <div class="portfolio-item p-3 mb-2 rounded ${isProfit ? 'profit' : 'loss'}">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <img src="${crypto.image || '/static/img/placeholder-crypto.png'}"
                                 alt="${crypto.name}"
                                 style="width: 32px; height: 32px; margin-right: 10px;">
                            <strong>${crypto.symbol.toUpperCase()}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Quantity</small><br>
                            ${holding.quantity.toFixed(8)}
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Avg Price</small><br>
                            ${holding.average_buy_price_gem.toFixed(2)} GEM
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Invested</small><br>
                            ${holding.total_invested_gem.toFixed(2)} GEM
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Current Value</small><br>
                            ${holding.current_value_gem.toFixed(2)} GEM
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">P&L</small><br>
                            <span class="${isProfit ? 'profit' : 'loss'}">
                                ${isProfit ? '+' : ''}${holding.profit_loss_gem.toFixed(2)} GEM
                                (${isProfit ? '+' : ''}${holding.profit_loss_percentage.toFixed(2)}%)
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    },

    async loadTransactions() {
        try {
            // Use direct fetch instead of App.api
            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/crypto/portfolio/transactions?limit=20', {
                method: 'GET',
                headers: headers,
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Transactions API response:', data);
                if (data.success) {
                    this.displayTransactions(data.transactions);
                }
            } else {
                console.error('Transactions API request failed:', response.status);
                this.showTransactionsError();
            }
        } catch (error) {
            console.error('Error loading transactions:', error);
            this.showTransactionsError();
        }
    },

    showTransactionsError() {
        document.getElementById('transactions-content').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Unable to load transaction history.
            </div>
        `;
    },

    displayTransactions(transactions) {
        const container = document.getElementById('transactions-content');

        if (!transactions || transactions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-list-ul text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No transactions yet</h5>
                    <p class="text-muted">Your transaction history will appear here.</p>
                </div>
            `;
            return;
        }

        let html = '';
        transactions.forEach(tx => {
            const isPositive = tx.amount > 0;
            const typeIcon = this.getTransactionIcon(tx.transaction_type);

            html += `
                <div class="transaction-row">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <i class="bi ${typeIcon}"></i>
                        </div>
                        <div class="col-md-3">
                            <strong>${tx.transaction_type.replace('_', ' ')}</strong><br>
                            <small class="text-muted">${new Date(tx.created_at).toLocaleString()}</small>
                        </div>
                        <div class="col-md-5">
                            ${tx.description}
                        </div>
                        <div class="col-md-2 text-end">
                            <span class="${isPositive ? 'profit' : 'loss'}">
                                ${isPositive ? '+' : ''}${tx.amount.toFixed(2)} GEM
                            </span>
                        </div>
                        <div class="col-md-1 text-end">
                            <small class="text-muted">${tx.balance_after.toFixed(2)}</small>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    },

    getTransactionIcon(type) {
        const icons = {
            'DEPOSIT': 'bi-plus-circle text-success',
            'WITHDRAWAL': 'bi-dash-circle text-danger',
            'BET_PLACED': 'bi-dice-5 text-primary',
            'BET_WON': 'bi-trophy text-warning',
            'BET_LOST': 'bi-x-circle text-danger',
            'CRYPTO_BUY': 'bi-cart-plus text-info',
            'CRYPTO_SELL': 'bi-cart-dash text-warning',
            'TRANSFER': 'bi-arrow-left-right text-secondary'
        };
        return icons[type] || 'bi-circle';
    },

    async refreshPortfolio() {
        document.getElementById('portfolio-content').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Refreshing portfolio...</p>
            </div>
        `;
        await this.loadPortfolio();
    },

    async refreshTransactions() {
        document.getElementById('transactions-content').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Refreshing transactions...</p>
            </div>
        `;
        await this.loadTransactions();
    },

    async testBalancePersistence() {
        const resultDiv = document.getElementById('persistence-result');

        try {
            // Use direct fetch instead of App.api
            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/crypto/portfolio/stats', {
                method: 'GET',
                headers: headers,
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const balance = data.data.wallet.gem_balance;

                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>Balance Persistence: WORKING</strong><br>
                            Current balance: ${balance.toFixed(2)} GEM<br>
                            <small>Your balance is properly stored in the database and persists across sessions.</small>
                        </div>
                    `;
                }
            } else {
                throw new Error(`API request failed: ${response.status}`);
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    <strong>Balance Persistence: ERROR</strong><br>
                    <small>Unable to verify balance persistence: ${error.message}</small>
                </div>
            `;
        }
    },

    // Profile editing functions
    showEditModal() {
        if (!this.userStats || !this.userStats.user) {
            alert('Profile data not loaded yet');
            return;
        }

        const user = this.userStats.user;

        // Populate form with current values
        document.getElementById('edit-username').value = user.username || '';
        document.getElementById('edit-email').value = user.email || '';
        document.getElementById('edit-bio').value = user.bio || '';
        document.getElementById('edit-avatar-url').value = user.avatar_url || '';
        document.getElementById('edit-theme').value = user.profile_theme || 'purple';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        modal.show();
    },

    async saveProfile() {
        try {
            const username = document.getElementById('edit-username').value;
            const email = document.getElementById('edit-email').value;
            const bio = document.getElementById('edit-bio').value;
            const avatar_url = document.getElementById('edit-avatar-url').value;
            const profile_theme = document.getElementById('edit-theme').value;

            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/auth/profile', {
                method: 'PUT',
                headers: headers,
                credentials: 'include',
                body: JSON.stringify({ username, email, bio, avatar_url, profile_theme })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                    modal.hide();

                    // Reload profile
                    await this.loadUserProfile();

                    // Show success message
                    if (window.App && window.App.showAlert) {
                        App.showAlert('success', 'Profile updated successfully!');
                    } else {
                        alert('Profile updated successfully!');
                    }
                }
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to update profile');
            }
        } catch (error) {
            console.error('Error saving profile:', error);
            if (window.App && window.App.showAlert) {
                App.showAlert('danger', `Error: ${error.message}`);
            } else {
                alert(`Error: ${error.message}`);
            }
        }
    },

    async handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Check file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            return;
        }

        try {
            // Convert to data URL and store
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;

                // Update avatar immediately for preview
                document.getElementById('profile-avatar').src = dataUrl;

                // Save to profile
                const token = localStorage.getItem('auth_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({ avatar_url: dataUrl })
                });

                if (response.ok) {
                    if (window.App && window.App.showAlert) {
                        App.showAlert('success', 'Avatar updated successfully!');
                    }
                    // Reload to update everywhere
                    await this.loadUserProfile();
                } else {
                    throw new Error('Failed to upload avatar');
                }
            };
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error uploading avatar:', error);
            alert('Error uploading avatar: ' + error.message);
        }
    }
};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('Profile page loaded, initializing...');
    // Simple initialization
    setTimeout(() => {
        Profile.init().catch(error => {
            console.error('Profile initialization failed:', error);
        });
    }, 500);
});
</script>
{% endblock %}
