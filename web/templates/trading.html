<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Trading - Crypto Analytics Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Enhanced Visual Styles -->
    <link href="/static/css/main.css" rel="stylesheet">
    <link href="/static/css/enhanced-theme.css" rel="stylesheet">
    <link href="/static/css/icons.css" rel="stylesheet">
    <link href="/static/css/visual-assets.css" rel="stylesheet">
    <link href="/static/css/trading-clean.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .trading-header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 2rem 0;
        }

        .portfolio-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }
        .neutral { color: #6b7280; }

        .holding-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: white;
        }

        .trade-form {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .btn-buy {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .btn-sell {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .transaction-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            display: none;
        }

        .performance-chart {
            height: 300px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
    </style>
</head>
<body class="trading-page">
    <!-- Global Navbar (consistent with base.html) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-dice me-2"></i>
                <span class="fw-bold">CryptoChecker</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-dice-d20 me-1"></i>Gaming
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/gaming/roulette"><i class="fas fa-circle-dot me-2"></i>Crypto Roulette</a></li>
                            <li><a class="dropdown-item" href="/gaming/dice"><i class="fas fa-dice me-2"></i>Dice Game</a></li>
                            <li><a class="dropdown-item" href="/gaming/crash"><i class="fas fa-rocket me-2"></i>Crash Game</a></li>
                            <li><a class="dropdown-item" href="/gaming/plinko"><i class="fas fa-circle me-2"></i>Plinko</a></li>
                            <li><a class="dropdown-item" href="/gaming/tower"><i class="fas fa-building me-2"></i>Tower</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/trading">
                            <i class="fas fa-exchange-alt me-1"></i>Trading
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/inventory">
                            <i class="fas fa-briefcase me-1"></i>Inventory
                        </a>
                    </li>
                </ul>
                
                <!-- Auth UI Hooks (aligned with /static/js/auth.js) -->
                <div class="navbar-nav" id="auth-buttons">
                    <div class="nav-item">
                        <button class="nav-link btn btn-outline-light btn-sm me-2" id="demo-login-btn">
                            <i class="fas fa-sign-in-alt me-1"></i>Demo Login
                        </button>
                    </div>
                    <div class="nav-item">
                        <a class="nav-link btn btn-light btn-sm" href="/register">
                            <i class="fas fa-user-plus me-1"></i>Register
                        </a>
                    </div>
                    <div class="nav-item ms-2">
                        <a class="nav-link btn btn-outline-light btn-sm" href="/login">
                            <i class="fas fa-right-to-bracket me-1"></i>Login
                        </a>
                    </div>
                </div>

                <!-- Authenticated User Menu Container -->
                <div class="navbar-nav" id="user-menu" style="display: none;">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <img src="/static/images/default-avatar.png" class="rounded-circle me-2" width="32" height="32" id="userAvatar" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2732%27 height=%2732%27%3E%3Crect width=%2732%27 height=%2732%27 rx=%276%27 fill=%27%23222%27/%3E%3C/svg%3E'">
                            <div class="d-flex flex-column">
                                <span class="fw-semibold" id="username-display">Username</span>
                                <small class="text-light opacity-75">Level <span id="userLevel">1</span></small>
                            </div>
                            <div class="ms-3 text-end">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-gem text-warning me-1"></i>
                                    <span id="nav-gem-balance">0</span>
                                </div>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/"><i class="fas fa-user me-2"></i>Dashboard</a></li>
                            <li><a class="dropdown-item" href="/achievements"><i class="fas fa-medal me-2"></i>Achievements</a></li>
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn" data-action="logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Spacer for fixed navbar -->
    <div style="height: 76px;"></div>
    <!-- Enhanced Header with Glassmorphism -->
    <div class="trading-header" style="background: var(--gradient-primary); position: relative; overflow: hidden;">
        <!-- Animated Background Pattern -->
        <div class="position-absolute w-100 h-100 pattern-dots" style="opacity: 0.1;"></div>
        
        <div class="container position-relative">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center animate-on-scroll" data-animation="fadeInUp">
                        <div class="logo-icon me-3">
                            â‚¿
                        </div>
                        <div>
                            <h1 class="mb-0 text-gradient">
                                Paper Trading Dashboard
                            </h1>
                            <p class="mb-0 mt-2 opacity-75">Practice trading with virtual money â€¢ Risk-free learning environment</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-neon" onclick="refreshDashboard()" id="refresh-btn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <div id="effects-badge" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-4">
        
        <!-- Enhanced Loading Indicator -->
        <div class="text-center my-5 loading" id="main-loading">
            <div class="loading-visual">
                <div class="loading-spinner-visual"></div>
            </div>
            <p class="mt-3 text-gradient fw-semibold">Loading portfolio data...</p>
        </div>

        <!-- Enhanced Portfolio Overview -->
        <div class="row mb-4 animate-on-scroll" id="portfolio-overview" style="display: none;" data-animation="fadeInUp">
            <div class="col-12">
                <div class="card-glass">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="gaming-icon me-3">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <h3 class="mb-0 text-gradient">Demo Trading Portfolio</h3>
                                <p class="mb-0 text-muted">Virtual trading environment</p>
                            </div>
                        </div>
                        <span class="badge bg-success" style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">
                            <i class="fas fa-circle me-2" style="font-size: 0.6rem;"></i>Active
                        </span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-2 col-sm-6 mb-3">
                            <div class="stat-visual" style="--stat-color: #4f46e5; --stat-color-light: #6366f1;">
                                <div class="stat-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="stat-value" id="portfolio-value">$0.00</div>
                                <div class="stat-label">Portfolio Value</div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-3">
                            <div class="stat-visual" style="--stat-color: #10b981; --stat-color-light: #22c55e;">
                                <div class="stat-icon">
                                    <i class="fas fa-trending-up"></i>
                                </div>
                                <div class="stat-value" id="total-return">$0.00</div>
                                <div class="stat-label">Total Return</div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-3">
                            <div class="stat-visual" style="--stat-color: #f59e0b; --stat-color-light: #fbbf24;">
                                <div class="stat-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-value" id="return-percentage">0.00%</div>
                                <div class="stat-label">Return %</div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-3">
                            <div class="stat-visual" style="--stat-color: #06b6d4; --stat-color-light: #0891b2;">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-value" id="cash-balance">$0.00</div>
                                <div class="stat-label">Cash Balance</div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-3">
                            <div class="stat-visual" style="--stat-color: #8b5cf6; --stat-color-light: #a855f7;">
                                <div class="stat-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="stat-value" id="total-trades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6 mb-3">
                            <div class="stat-visual" style="--stat-color: #ef4444; --stat-color-light: #f87171;">
                                <div class="stat-icon">
                                    <i class="fas fa-target"></i>
                                </div>
                                <div class="stat-value" id="win-rate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="main-content" style="display: none;">
            <!-- Portfolio Holdings -->
            <div class="col-lg-8">
                <div class="card-glass animate-on-scroll" data-animation="fadeInUp" data-delay="100">
                    <h4 class="mb-4 d-flex align-items-center">
                        <div class="crypto-icon crypto-btc me-3">â‚¿</div>
                        <span class="text-gradient">Current Holdings</span>
                    </h4>
                    <div id="holdings-list">
                        <!-- Holdings will be populated here -->
                    </div>
                </div>

                <!-- Open Orders -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="200">
                    <h4 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3">
                            <i class="fas fa-list"></i>
                        </div>
                        <span class="text-gradient">Open Orders</span>
                    </h4>
                    <div id="open-orders-list" class="text-muted">Loading open orders...</div>
                </div>

                <!-- Recent Transactions -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="300">
                    <h4 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-success);">
                            <i class="fas fa-history"></i>
                        </div>
                        <span class="text-gradient">Recent Transactions</span>
                    </h4>
                    <div id="transactions-list">
                        <!-- Transactions will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Enhanced Trading Panel -->
            <div class="col-lg-4 trading-sidebar">
                <div class="card-glass animate-on-scroll" data-animation="fadeInUp" data-delay="100">
                    <h4 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-crypto);">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span class="text-gradient">Quick Trade</span>
                    </h4>
                    
                    <form id="trade-form">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Cryptocurrency</label>
                            <select class="form-select" id="trade-coin" required style="border-radius: 12px; border: 2px solid rgba(79, 70, 229, 0.2); background: rgba(255, 255, 255, 0.9);">
                                <option value="">Select a coin...</option>
                                <option value="bitcoin">ðŸŸ  Bitcoin (BTC)</option>
                                <option value="ethereum">ðŸ”µ Ethereum (ETH)</option>
                                <option value="ripple">âšª XRP (XRP)</option>
                                <option value="binancecoin">ðŸŸ¡ BNB (BNB)</option>
                                <option value="solana">ðŸŸ£ Solana (SOL)</option>
                                <option value="cardano">ðŸ”µ Cardano (ADA)</option>
                                <option value="dogecoin">ðŸŸ¡ Dogecoin (DOGE)</option>
                                <option value="polygon">ðŸŸ£ Polygon (MATIC)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Action</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="trade-action" id="action-buy" value="buy" checked>
                                <label class="btn btn-neon" for="action-buy" style="border-color: #22c55e; color: #22c55e;">
                                    <i class="fas fa-arrow-up me-2"></i>Buy
                                </label>
                                
                                <input type="radio" class="btn-check" name="trade-action" id="action-sell" value="sell">
                                <label class="btn btn-neon" for="action-sell" style="border-color: #ef4444; color: #ef4444;">
                                    <i class="fas fa-arrow-down me-2"></i>Sell
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Amount (USD)</label>
                            <input type="number" class="form-control bet-amount-input" id="trade-amount" 
                                   placeholder="1000" min="1" step="0.01" required>
                            <div class="form-text">
                                Enter USD amount to trade. Conversion uses real-time price. 
                                <br>GEM conversion: 1 GEM = ${{ '%.4f'|format(gem_usd_rate) }} 
                                (1000 GEM = ${{ '%.2f'|format(gem_usd_rate*1000) }}).
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Order Type</label>
                            <select class="form-select" id="order-type" style="border-radius: 12px; border: 2px solid rgba(79, 70, 229, 0.2); background: rgba(255, 255, 255, 0.9);">
                                <option value="MARKET">âš¡ Market Order (Execute Immediately)</option>
                                <option value="LIMIT">ðŸ“Š Limit Order (Not yet implemented)</option>
                            </select>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-neon" style="padding: 0.75rem 1.5rem; font-weight: 600;">
                                <i class="fas fa-paper-plane me-2"></i>
                                Place Order
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Enhanced Replace Protections -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="200">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-warning); width: 40px; height: 40px;">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span class="text-gradient">Replace Protections (OCO)</span>
                    </h5>
                    <form id="protect-form">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Coin</label>
                            <select class="form-select" id="protect-coin" style="border-radius: 12px; border: 2px solid rgba(79, 70, 229, 0.2); background: rgba(255, 255, 255, 0.9);">
                                <option value="bitcoin|BTC">ðŸŸ  Bitcoin (BTC)</option>
                                <option value="ethereum|ETH">ðŸ”µ Ethereum (ETH)</option>
                                <option value="solana|SOL">ðŸŸ£ Solana (SOL)</option>
                                <option value="cardano|ADA">ðŸ”µ Cardano (ADA)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Stop Loss (%)</label>
                            <input type="number" class="form-control bet-amount-input" id="sl-pct" placeholder="5" min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Take Profit (%)</label>
                            <input type="number" class="form-control bet-amount-input" id="tp-pct" placeholder="10" min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Existing OCO Group ID (optional)</label>
                            <input type="text" class="form-control bet-amount-input" id="oco-group-id" placeholder="Enter group ID...">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-neon" style="border-color: #f59e0b; color: #f59e0b;">
                                <i class="fas fa-shield-alt me-2"></i>Replace Protections
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Enhanced Performance Summary -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="300">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-success); width: 40px; height: 40px;">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <span class="text-gradient">Performance Summary</span>
                    </h5>
                    <div class="performance-chart" id="performance-summary" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 12px;">
                        <div class="text-center">
                            <div class="loading-dots-visual mb-3">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            <p class="text-muted">Performance metrics will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Gamification Wallet -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="400">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="crypto-icon crypto-btc me-3" style="width: 40px; height: 40px;">
                            ðŸ’Ž
                        </div>
                        <span class="text-gradient">Gamification Wallet</span>
                    </h5>
                    <div id="wallet-summary">
                        <div class="text-center text-muted py-3">
                            <div class="loading-dots-visual mb-2">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            Loading wallet...
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <a class="btn btn-neon btn-sm" href="/inventory" style="border-color: #10b981; color: #10b981;">
                            <i class="fas fa-box-open me-2"></i>View Full Inventory
                        </a>
                    </div>
                </div>

                <!-- Enhanced Inventory Preview -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="500">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-gaming); width: 40px; height: 40px;">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <span class="text-gradient">Inventory Preview</span>
                    </h5>
                    <div id="inventory-preview">
                        <div class="text-center text-muted py-3">
                            <div class="loading-dots-visual mb-2">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            Loading inventory...
                        </div>
                    </div>
                </div>

                <!-- Enhanced Consumables -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="600">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-success); width: 40px; height: 40px;">
                            <i class="fas fa-flask"></i>
                        </div>
                        <span class="text-gradient">Consumables</span>
                    </h5>
                    <div id="consumables-list">
                        <div class="text-center text-muted py-3">
                            <div class="loading-dots-visual mb-2">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            Loading consumables...
                        </div>
                    </div>
                </div>

                <!-- Enhanced Recent Rewards & Activity -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="700">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="achievement-icon-visual me-3" style="width: 40px; height: 40px; font-size: 16px;">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <span class="text-gradient">Recent Rewards & Activity</span>
                    </h5>
                    <div id="activity-feed">
                        <div class="text-center text-muted py-3">
                            <div class="loading-dots-visual mb-2">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            Loading activity...
                        </div>
                    </div>
                </div>

                <!-- Enhanced Active Effects -->
                <div class="card-glass animate-on-scroll mt-4" data-animation="fadeInUp" data-delay="800">
                    <h5 class="mb-4 d-flex align-items-center">
                        <div class="gaming-icon me-3" style="background: var(--gradient-warning); width: 40px; height: 40px;">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <span class="text-gradient">Active Effects</span>
                    </h5>
                    <div id="effects-list">
                        <div class="text-center text-muted py-3">
                            <div class="loading-dots-visual mb-2">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            Loading effects...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core scripts (match base.html order for auth state) -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>

    <!-- Enhanced JavaScript -->
    <script src="/static/js/main.js"></script>
    <script src="/static/js/animations.js"></script>
    
    <!-- Alert Container for Notifications -->
    <div id="alertContainer" class="position-fixed" style="top: 100px; right: 20px; z-index: 9999; max-width: 400px;"></div>
    
    <script>
        // Expose GEM rate to client scripts
        window.GEM_USD_RATE = {{ '%.6f'|format(gem_usd_rate) }};
        // Application state
        let portfolioData = null;
        let currentHoldings = [];
        let recentTransactions = [];
        let walletData = null;
        let inventoryData = null;
        let activityData = null;
        let effectsData = null;

        // Utility functions for enhanced visuals
        function getCryptoClass(symbol) {
            const cryptoClasses = {
                'BTC': 'crypto-btc',
                'ETH': 'crypto-eth',
                'ADA': 'crypto-ada',
                'SOL': 'crypto-sol',
                'DOT': 'crypto-dot',
                'DOGE': 'crypto-doge',
                'MATIC': 'crypto-matic',
                'AVAX': 'crypto-avax',
                'LINK': 'crypto-link',
                'UNI': 'crypto-uni'
            };
            return cryptoClasses[symbol.toUpperCase()] || 'crypto-btc';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatCrypto(amount) {
            return parseFloat(amount).toFixed(8);
        }

        function showSuccess(message) {
            if (window.animationManager) {
                window.animationManager.animateNotification(message, 'success', 5000);
            } else if (window.showAlert) {
                window.showAlert(message, 'success');
            } else {
                alert(message);
            }
        }

        function showError(message) {
            if (window.animationManager) {
                window.animationManager.animateNotification(message, 'error', 5000);
            } else if (window.showAlert) {
                window.showAlert(message, 'danger');
            } else {
                alert(message);
            }
        }

        function showLoading(show) {
            const loadingElement = document.getElementById('main-loading');
            const contentElement = document.getElementById('main-content');
            const overviewElement = document.getElementById('portfolio-overview');
            
            if (show) {
                if (loadingElement) loadingElement.style.display = 'block';
                if (contentElement) contentElement.style.display = 'none';
                if (overviewElement) overviewElement.style.display = 'none';
            } else {
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        function showMainContent() {
            const overviewElement = document.getElementById('portfolio-overview');
            const contentElement = document.getElementById('main-content');
            
            if (overviewElement) overviewElement.style.display = 'block';
            if (contentElement) contentElement.style.display = 'block';
            
            // Trigger scroll animations
            if (window.animationManager) {
                setTimeout(() => {
                    document.querySelectorAll('.animate-on-scroll').forEach(el => {
                        if (window.animationManager) {
                            window.animationManager.animateElement(el);
                        }
                    });
                }, 100);
            }
        }

        function refreshDashboard() {
            try {
                if (window.animationManager) {
                    window.animationManager.animateNotification('Refreshing dashboard...', 'info', 2000);
                }
                
                // Reload all data
                loadPortfolioData();
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                showError('Failed to refresh dashboard');
            }
        }

        // Use global logout from auth.js

        function checkAuthenticationState() {
            // Defer to auth.js which calls /api/auth/me and updates UI
            try {
                if (window.auth && window.auth.checkAuthStatus) {
                    window.auth.checkAuthStatus();
                }
            } catch (e) { console.debug('Auth check skipped:', e); }
        }

        function updateWalletDisplay() {
            if (!walletData) return;
            
            const walletSummary = document.getElementById('wallet-summary');
            if (walletSummary) {
                walletSummary.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center p-3" style="background: rgba(247, 147, 26, 0.2); border: 1px solid rgba(247, 147, 26, 0.3); border-radius: 12px;">
                        <div class="d-flex align-items-center">
                            <div class="crypto-icon crypto-btc me-3" style="width: 32px; height: 32px; font-size: 14px;">ðŸ’Ž</div>
                            <span class="fw-semibold">GEM Coins:</span>
                        </div>
                        <span class="fw-bold text-warning">${window.utils ? window.utils.formatNumber(walletData.gem_coins) : walletData.gem_coins}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center p-3 mt-2" style="background: rgba(79, 70, 229, 0.2); border: 1px solid rgba(79, 70, 229, 0.3); border-radius: 12px;">
                        <div class="d-flex align-items-center">
                            <div class="gaming-icon me-3" style="width: 32px; height: 32px; font-size: 14px; background: var(--gradient-success);">
                                <i class="fas fa-star"></i>
                            </div>
                            <span class="fw-semibold">XP Points:</span>
                        </div>
                        <span class="fw-bold text-info">${walletData.xp || 0}</span>
                    </div>
                `;
            }
            
            // Update header wallet display
            const headerBalance = document.getElementById('header-gem-balance');
            if (headerBalance) {
                animateStatValue('header-gem-balance', walletData.gem_coins, window.utils ? window.utils.formatNumber : null);
            }
        }

        function updateInventoryPreview() {
            const inventoryPreview = document.getElementById('inventory-preview');
            if (!inventoryPreview) return;
            
            if (!inventoryData || !inventoryData.items || inventoryData.items.length === 0) {
                inventoryPreview.innerHTML = `
                    <div class="text-center py-4">
                        <div class="crypto-icon crypto-eth mb-3" style="width: 60px; height: 60px; font-size: 24px; margin: 0 auto; opacity: 0.5;">
                            ðŸ“¦
                        </div>
                        <p class="text-muted">No items in inventory</p>
                        <a href="/gaming/roulette" class="btn btn-neon btn-sm" style="border-color: #10b981; color: #10b981;">
                            <i class="fas fa-dice me-2"></i>Play Games to Earn Items
                        </a>
                    </div>
                `;
                return;
            }
            
            const itemsHTML = inventoryData.items.slice(0, 3).map(item => `
                <div class="d-flex align-items-center p-2 mb-2" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                    <div class="rarity-indicator rarity-${item.rarity || 'common'} me-3"></div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${item.name}</div>
                        <div class="small text-muted">${item.rarity || 'Common'}</div>
                    </div>
                    <div class="small text-muted">x${item.quantity || 1}</div>
                </div>
            `).join('');
            
            inventoryPreview.innerHTML = itemsHTML;
        }

        function updateActivityFeed() {
            const activityFeed = document.getElementById('activity-feed');
            if (!activityFeed) return;
            
            if (!activityData || !activityData.activities || activityData.activities.length === 0) {
                activityFeed.innerHTML = `
                    <div class="text-center py-4">
                        <div class="achievement-icon-visual mb-3" style="width: 60px; height: 60px; font-size: 24px; margin: 0 auto; opacity: 0.5;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <p class="text-muted">No recent activity</p>
                        <a href="/gaming/roulette" class="btn btn-neon btn-sm" style="border-color: #8b5cf6; color: #8b5cf6;">
                            <i class="fas fa-play me-2"></i>Start Gaming
                        </a>
                    </div>
                `;
                return;
            }
            
            const activitiesHTML = activityData.activities.slice(0, 5).map(activity => `
                <div class="d-flex align-items-center p-2 mb-2" style="background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                    <div class="gaming-icon me-3" style="width: 32px; height: 32px; font-size: 14px;">
                        <i class="fas fa-${activity.icon || 'star'}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${activity.title}</div>
                        <div class="small text-muted">${activity.description}</div>
                    </div>
                    <div class="small text-success">+${activity.reward || 0}</div>
                </div>
            `).join('');
            
            activityFeed.innerHTML = activitiesHTML;
        }

        function updateTransactionsDisplay() {
            const transactionsList = document.getElementById('transactions-list');
            if (!transactionsList) return;
            
            if (!recentTransactions || recentTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="text-center py-4">
                        <div class="gaming-icon mb-3" style="width: 60px; height: 60px; font-size: 24px; margin: 0 auto; opacity: 0.5; background: var(--gradient-success);">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <p class="text-muted">No transactions yet</p>
                        <button class="btn btn-neon btn-sm" onclick="document.getElementById('trade-coin').focus()" style="border-color: #22c55e; color: #22c55e;">
                            <i class="fas fa-plus me-2"></i>Place First Trade
                        </button>
                    </div>
                `;
                return;
            }
            
            const transactionsHTML = recentTransactions.map(transaction => `
                <div class="transaction-item">
                    <div>
                        <strong>${transaction.order_side.toUpperCase()}</strong> ${transaction.coin_symbol.toUpperCase()}
                        <div class="small text-muted">${formatCurrency(transaction.total_value)} â€¢ ${new Date(transaction.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-semibold ${transaction.order_side === 'buy' ? 'text-success' : 'text-danger'}">
                            ${transaction.order_side === 'buy' ? '+' : '-'}${formatCrypto(transaction.quantity)}
                        </div>
                        <div class="small text-muted">${formatCurrency(transaction.price)}</div>
                    </div>
                </div>
            `).join('');
            
            transactionsList.innerHTML = transactionsHTML;
        }

        async function loadConsumables() {
            const consumablesList = document.getElementById('consumables-list');
            if (!consumablesList) return;
            
            consumablesList.innerHTML = `
                <div class="text-center py-4">
                    <div class="gaming-icon mb-3" style="width: 60px; height: 60px; font-size: 24px; margin: 0 auto; opacity: 0.5; background: var(--gradient-success);">
                        <i class="fas fa-flask"></i>
                    </div>
                    <p class="text-muted">No consumables available</p>
                    <a href="/inventory" class="btn btn-neon btn-sm" style="border-color: #10b981; color: #10b981;">
                        <i class="fas fa-shopping-cart me-2"></i>Visit Shop
                    </a>
                </div>
            `;
        }

        async function loadEffects() {
            const effectsList = document.getElementById('effects-list');
            if (!effectsList) return;
            
            effectsList.innerHTML = `
                <div class="text-center py-4">
                    <div class="gaming-icon mb-3" style="width: 60px; height: 60px; font-size: 24px; margin: 0 auto; opacity: 0.5; background: var(--gradient-warning);">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <p class="text-muted">No active effects</p>
                    <small class="text-muted">Use consumables to activate effects</small>
                </div>
            `;
        }



        async function executeTrade() {
            const coin = document.getElementById('trade-coin').value;
            const action = document.querySelector('input[name="trade-action"]:checked').value;
            const amount = parseFloat(document.getElementById('trade-amount').value);
            
            if (!coin || !amount || amount < 1) {
                showError('Please fill in all required fields');
                return;
            }
            
            try {
                // Simulate trade execution
                if (window.animationManager) {
                    window.animationManager.animateNotification(`${action.toUpperCase()} order for $${amount} ${coin.toUpperCase()} placed successfully!`, 'success');
                } else {
                    showSuccess(`${action.toUpperCase()} order placed successfully!`);
                }
                
                // Reset form
                document.getElementById('trade-form').reset();
                
                // Refresh data
                setTimeout(() => {
                    loadPortfolioData();
                }, 1000);
                
            } catch (error) {
                console.error('Trade execution failed:', error);
                showError('Failed to execute trade');
            }
        }

        // Fallback alert function if main.js doesn't load
        if (!window.showAlert) {
            window.showAlert = function(message, type) {
                console.log(`Alert: ${message} (${type})`);
                const alertContainer = document.getElementById('alertContainer');
                if (alertContainer) {
                    const alertId = 'alert-' + Date.now();
                    const alertHTML = `
                        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    alertContainer.insertAdjacentHTML('beforeend', alertHTML);
                    
                    setTimeout(() => {
                        const alert = document.getElementById(alertId);
                        if (alert) alert.remove();
                    }, 5000);
                } else {
                    alert(message);
                }
            };
        }

        // Safe initialization with error handling
        function safeInit() {
            try {
                console.log('Starting safe initialization...');
                
                // Check if required elements exist
                const requiredElements = ['portfolio-overview', 'main-content', 'main-loading'];
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.warn('Missing elements:', missingElements);
                }
                
                checkAuthenticationState();
                loadPortfolioData();
                setupEventListeners();
                
                console.log('Initialization completed successfully');
                
            } catch (error) {
                console.error('Error during initialization:', error);
                
                // Show user-friendly error message
                const container = document.querySelector('.container');
                if (container) {
                    container.innerHTML = `
                        <div class="row justify-content-center mt-5">
                            <div class="col-md-8">
                                <div class="card-glass text-center py-5">
                                    <div class="gaming-icon mb-4" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto; background: var(--gradient-warning);">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <h3 class="text-gradient mb-3">Loading Issue</h3>
                                    <p class="text-white opacity-75 mb-4">
                                        We're having trouble loading some features. The page is still functional, 
                                        but some advanced features may not work properly.
                                    </p>
                                    <div class="d-flex gap-3 justify-content-center">
                                        <button class="btn btn-neon" onclick="window.location.reload()">
                                            <i class="fas fa-refresh me-2"></i>Refresh Page
                                        </button>
                                        <a href="/" class="btn btn-neon" style="border-color: #8b5cf6; color: #8b5cf6;">
                                            <i class="fas fa-home me-2"></i>Go Home
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInit);
        } else {
            safeInit();
        }

        function setupEventListeners() {
            // Trade form submission
            document.getElementById('trade-form').addEventListener('submit', function(e) {
                e.preventDefault();
                executeTrade();
            });
            document.getElementById('protect-form').addEventListener('submit', function(e) {
                e.preventDefault();
                replaceProtections();
            });
        }

        async function loadPortfolioData() {
            try {
                showLoading(true);

                // Load portfolio summary with error handling
                try {
                    const summaryResponse = await fetch('/api/trading/portfolio/demo-portfolio-456/summary');
                    if (summaryResponse.ok) {
                        const summaryData = await summaryResponse.json();
                        if (summaryData.status === 'success') {
                            portfolioData = summaryData.data;
                            updatePortfolioDisplay();
                            updateHoldingsDisplay();
                        } else {
                            // Use mock data if API fails
                            portfolioData = createMockPortfolioData();
                            updatePortfolioDisplay();
                            updateHoldingsDisplay();
                        }
                    } else {
                        // Use mock data if API fails
                        portfolioData = createMockPortfolioData();
                        updatePortfolioDisplay();
                        updateHoldingsDisplay();
                    }
                } catch (e) {
                    console.warn('Portfolio API failed, using mock data:', e);
                    portfolioData = createMockPortfolioData();
                    updatePortfolioDisplay();
                    updateHoldingsDisplay();
                }

                // Load open orders with fallback
                try {
                    await loadOpenOrders();
                } catch (e) { 
                    console.warn('Open orders fetch failed', e);
                    document.getElementById('open-orders-list').innerHTML = '<div class="text-muted">No open orders.</div>';
                }

                // Load recent transactions with fallback
                try {
                    const transactionsResponse = await fetch('/api/trading/portfolio/demo-portfolio-456/transactions?limit=10');
                    if (transactionsResponse.ok) {
                        const transactionsData = await transactionsResponse.json();
                        if (transactionsData.status === 'success') {
                            recentTransactions = transactionsData.data.transactions;
                            updateTransactionsDisplay();
                        }
                    } else {
                        updateTransactionsDisplay(); // Will show empty state
                    }
                } catch (e) { 
                    console.warn('Transactions fetch failed', e);
                    updateTransactionsDisplay(); // Will show empty state
                }

                // Load wallet with fallback
                try {
                    const walletResponse = await fetch('/api/trading/gamification/wallet');
                    if (walletResponse.ok) {
                        const walletJson = await walletResponse.json();
                        if (walletJson.status === 'success') {
                            walletData = walletJson.data;
                            updateWalletDisplay();
                        }
                    } else {
                        walletData = { gem_coins: 1000, xp: 0 };
                        updateWalletDisplay();
                    }
                } catch (e) { 
                    console.warn('Wallet fetch failed', e);
                    walletData = { gem_coins: 1000, xp: 0 };
                    updateWalletDisplay();
                }

                // Load inventory preview with fallback
                try {
                    const invResponse = await fetch('/api/trading/gamification/inventory?per_page=5');
                    if (invResponse.ok) {
                        const invJson = await invResponse.json();
                        if (invJson.status === 'success') {
                            inventoryData = invJson.data;
                            updateInventoryPreview();
                        }
                    } else {
                        updateInventoryPreview(); // Will show empty state
                    }
                } catch (e) { 
                    console.warn('Inventory fetch failed', e);
                    updateInventoryPreview(); // Will show empty state
                }

                // Load consumables with fallback
                try {
                    await loadConsumables();
                } catch (e) { 
                    console.warn('Consumables fetch failed', e);
                    document.getElementById('consumables-list').innerHTML = '<div class="text-muted">No consumables available.</div>';
                }

                // Load recent activity with fallback
                try {
                    const actResponse = await fetch('/api/trading/gamification/activity');
                    if (actResponse.ok) {
                        const actJson = await actResponse.json();
                        if (actJson.status === 'success') {
                            activityData = actJson.data;
                            updateActivityFeed();
                        }
                    } else {
                        updateActivityFeed(); // Will show empty state
                    }
                } catch (e) { 
                    console.warn('Activity fetch failed', e);
                    updateActivityFeed(); // Will show empty state
                }

                // Load active effects with fallback
                try {
                    await loadEffects();
                } catch (e) { 
                    console.warn('Effects fetch failed', e);
                    document.getElementById('effects-list').innerHTML = '<div class="text-muted">No active effects.</div>';
                }

                showMainContent();

            } catch (error) {
                console.error('Error loading portfolio data:', error);
                showError('Failed to load some data, but continuing with available information');
                showMainContent();
            } finally {
                showLoading(false);
            }
        }

        function createMockPortfolioData() {
            return {
                portfolio: {
                    total_portfolio_value: 10000.00,
                    total_return: 500.00,
                    total_return_percentage: 5.26,
                    current_balance: 2500.00,
                    total_trades: 15,
                    win_rate: 73.3
                },
                holdings: [
                    {
                        coin_symbol: 'BTC',
                        coin_id: 'bitcoin',
                        quantity: 0.25,
                        average_cost: 45000,
                        current_price: 47000,
                        market_value: 11750,
                        profit_loss: 500
                    },
                    {
                        coin_symbol: 'ETH',
                        coin_id: 'ethereum',
                        quantity: 2.5,
                        average_cost: 3000,
                        current_price: 3200,
                        market_value: 8000,
                        profit_loss: 500
                    }
                ]
            };
        }

        async function replaceProtections() {
            try {
                const coinSel = document.getElementById('protect-coin').value.split('|');
                const coinId = coinSel[0];
                const coinSymbol = coinSel[1];
                const slPct = parseFloat(document.getElementById('sl-pct').value || '0') / 100.0;
                const tpPct = parseFloat(document.getElementById('tp-pct').value || '0') / 100.0;
                const ocoId = document.getElementById('oco-group-id').value.trim();
                const body = {
                    coin_id: coinId,
                    coin_symbol: coinSymbol,
                    sl_pct: slPct > 0 ? slPct : null,
                    tp_pct: tpPct > 0 ? tpPct : null,
                    cancel_existing: true
                };
                if (ocoId) body.oco_group_id = ocoId;
                const resp = await fetch('/api/trading/portfolio/demo-portfolio-456/orders/protect/replace', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)});
                const data = await resp.json();
                if (data.status === 'success') { showSuccess('Protections replaced'); loadOpenOrders(); }
                else { showError('Failed to replace protections'); }
            } catch (e) { showError('Error replacing protections'); }
        }

        async function loadOpenOrders() {
            const resp = await fetch('/api/trading/portfolio/demo-portfolio-456/orders/open');
            const data = await resp.json();
            const el = document.getElementById('open-orders-list');
            if (data.status !== 'success' || !data.data || !data.data.orders || data.data.orders.length === 0) {
                el.innerHTML = '<div class="text-muted">No open orders.</div>';
                return;
            }
            const rows = data.data.orders.map(o => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${o.order_type}</strong> ${o.order_side} ${o.quantity} ${o.coin_symbol}
                        <div class="text-muted">${o.price ? 'Price: ' + formatCurrency(o.price) : ''} ${o.stop_price ? 'Stop: ' + formatCurrency(o.stop_price) : ''}</div>
                        ${o.oco_group_id ? `<div class="badge bg-light text-dark">OCO Group: ${o.oco_group_id.substring(0,8)}...</div>` : ''}
                    </div>
                    <div>
                        ${o.oco_group_id ? `<button class="btn btn-sm btn-outline-warning me-2" onclick="cancelOcoGroup('${o.oco_group_id}')">Cancel Group</button>` : ''}
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('${o.id}')">Cancel</button>
                    </div>
                </div>
            `).join('');
            el.innerHTML = rows;
        }

        async function cancelOrder(orderId) {
            try {
                const resp = await fetch(`/api/trading/orders/${orderId}/cancel`, { method: 'POST' });
                const data = await resp.json();
                if (data.status === 'success') { showSuccess('Order cancelled'); loadOpenOrders(); }
                else { showError('Failed to cancel order'); }
            } catch (e) { showError('Error cancelling order'); }
        }

        async function cancelOcoGroup(groupId) {
            try {
                const resp = await fetch(`/api/trading/oco/${groupId}/cancel`, { method: 'POST' });
                const data = await resp.json();
                if (data.status === 'success') { showSuccess('OCO group cancelled'); loadOpenOrders(); }
                else { showError('Failed to cancel OCO group'); }
            } catch (e) { showError('Error cancelling OCO group'); }
        }

        function updatePortfolioDisplay() {
            if (!portfolioData) return;

            const portfolio = portfolioData.portfolio;
            
            // Animate portfolio value update
            animateStatValue('portfolio-value', portfolio.total_portfolio_value, formatCurrency);
            
            // Animate return with color coding
            const returnElement = document.getElementById('total-return');
            animateStatValue('total-return', portfolio.total_return, formatCurrency);
            returnElement.className = `stat-value ${portfolio.total_return >= 0 ? 'positive' : 'negative'}`;
            
            // Animate return percentage with color coding
            const returnPctElement = document.getElementById('return-percentage');
            animateStatValue('return-percentage', portfolio.total_return_percentage, (val) => `${val.toFixed(2)}%`);
            returnPctElement.className = `stat-value ${portfolio.total_return_percentage >= 0 ? 'positive' : 'negative'}`;
            
            // Animate other metrics
            animateStatValue('cash-balance', portfolio.current_balance, formatCurrency);
            animateStatValue('total-trades', portfolio.total_trades);
            animateStatValue('win-rate', portfolio.win_rate, (val) => `${val.toFixed(1)}%`);
            
            // Update header wallet display if available
            if (walletData && walletData.gem_coins) {
                const headerBalance = document.getElementById('header-gem-balance');
                if (headerBalance) {
                    animateStatValue('header-gem-balance', walletData.gem_coins, window.utils.formatNumber);
                }
                // Navbar gem counter updates via auth.js; no header wallet pill
            }
        }

        function animateStatValue(elementId, targetValue, formatter = null) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseFloat(element.textContent.replace(/[^0-9.-]/g, '')) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function for smooth animation
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const current = currentValue + (targetValue - currentValue) * easeOutCubic;
                
                element.textContent = formatter ? formatter(current) : Math.round(current);
                
                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }
            
            requestAnimationFrame(updateValue);
        }

        function updateHoldingsDisplay() {
            const holdingsList = document.getElementById('holdings-list');
            
            if (!portfolioData || !portfolioData.holdings || portfolioData.holdings.length === 0) {
                holdingsList.innerHTML = `
                    <div class="text-center py-5">
                        <div class="crypto-icon crypto-btc mb-4" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto; opacity: 0.5;">
                            â‚¿
                        </div>
                        <h5 class="text-muted mb-3">No Holdings Yet</h5>
                        <p class="text-muted">Start by placing your first trade to see your portfolio here!</p>
                        <button class="btn btn-neon mt-3" onclick="document.getElementById('trade-coin').focus()">
                            <i class="fas fa-plus me-2"></i>Place First Trade
                        </button>
                    </div>
                `;
                return;
            }

            const holdingsHTML = portfolioData.holdings.map((holding, index) => {
                const cryptoClass = getCryptoClass(holding.coin_symbol);
                const profitLossClass = holding.profit_loss >= 0 ? 'positive' : 'negative';
                
                return `
                    <div class="holding-item animate-on-scroll" data-animation="fadeInUp" data-delay="${index * 100}" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; transition: all 0.3s ease;">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="crypto-icon ${cryptoClass} me-3">
                                        ${holding.coin_symbol.toUpperCase()}
                                    </div>
                                    <div>
                                        <strong class="text-gradient">${holding.coin_symbol.toUpperCase()}</strong>
                                        <div class="small text-muted">${holding.coin_id}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">Quantity</div>
                                <div class="fw-semibold">${formatCrypto(holding.quantity)}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">Avg Cost</div>
                                <div class="fw-semibold">${formatCurrency(holding.average_cost)}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">Current Price</div>
                                <div class="fw-semibold">${formatCurrency(holding.current_price)}</div>
                            </div>
                            <div class="col-md-2">
                                <div class="small text-muted">Market Value</div>
                                <div class="fw-semibold">${formatCurrency(holding.market_value)}</div>
                            </div>
                            <div class="col-md-1">
                                <div class="small text-muted">P&L</div>
                                <div class="fw-semibold ${profitLossClass}">
                                    ${formatCurrency(holding.profit_loss)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            holdingsList.innerHTML = holdingsHTML;
        }

        function updateTransactionsDisplay() {
            const transactionsList = document.getElementById('transactions-list');
            
            if (!recentTransactions || recentTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-history fa-3x mb-3 opacity-50"></i>
                        <p>No transactions yet. Your trading history will appear here.</p>
                    </div>
                `;
                return;
            }

            const transactionsHTML = recentTransactions.slice(0, 5).map(tx => {
                const date = new Date(tx.created_at).toLocaleDateString();
                const time = new Date(tx.created_at).toLocaleTimeString();
                
                return `
                    <div class="transaction-item">
                        <div>
                            <div class="fw-bold">${tx.description}</div>
                            <div class="small text-muted">${date} ${time}</div>
                        </div>
                        <div class="text-end">
                            <div class="${tx.amount >= 0 ? 'positive' : 'negative'}">${formatCurrency(Math.abs(tx.amount))}</div>
                            ${tx.fee > 0 ? `<div class="small text-muted">Fee: ${formatCurrency(tx.fee)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            transactionsList.innerHTML = transactionsHTML;
        }

        async function executeTrade() {
            try {
                const formData = new FormData(document.getElementById('trade-form'));
                const coinId = document.getElementById('trade-coin').value;
                const action = document.querySelector('input[name="trade-action"]:checked').value;
                const amount = parseFloat(document.getElementById('trade-amount').value);

                if (!coinId || !amount) {
                    showError('Please fill in all fields');
                    return;
                }

                // Show loading
                const submitBtn = document.querySelector('#trade-form button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                submitBtn.disabled = true;

                // Execute quick trade
                const response = await fetch(`/api/trading/quick-trade/${action}/${coinId}?amount=${amount}`, {
                    method: 'GET'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showSuccess(result.data.message);
                    
                    // Reset form and refresh data
                    document.getElementById('trade-form').reset();
                    document.getElementById('action-buy').checked = true;
                    
                    setTimeout(() => {
                        loadPortfolioData();
                    }, 1000);
                } else {
                    showError(result.detail || 'Trade execution failed');
                }

            } catch (error) {
                console.error('Trade execution error:', error);
                showError('Failed to execute trade');
            } finally {
                // Restore button
                const submitBtn = document.querySelector('#trade-form button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Place Order';
                submitBtn.disabled = false;
            }
        }

        function refreshDashboard() {
            loadPortfolioData();
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('main-loading').style.display = show ? 'block' : 'none';
        }

        function showMainContent() {
            document.getElementById('portfolio-overview').style.display = 'block';
            document.getElementById('main-content').style.display = 'block';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatCrypto(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 8
            }).format(amount);
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'danger');
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function updateWalletDisplay() {
            const el = document.getElementById('wallet-summary');
            if (!walletData || !walletData.wallet) {
                el.innerHTML = '<div class="text-muted">No wallet found.</div>';
                return;
            }
            const w = walletData.wallet;
            el.innerHTML = `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">GEM Coins</span>
                    <strong class="text-warning">${Math.round(w.gem_coins)}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Experience</span>
                    <strong>${w.experience_points} XP</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Level</span>
                    <strong>${w.level}</strong>
                </div>
            `;
        }

        function updateInventoryPreview() {
            const el = document.getElementById('inventory-preview');
            if (!inventoryData || !inventoryData.items || inventoryData.items.length === 0) {
                el.innerHTML = '<div class="text-muted">No items yet. Play or trade to earn drops!</div>';
                return;
            }
            const items = inventoryData.items;
            el.innerHTML = items.map(it => `
                <div class="d-flex justify-content-between border-bottom py-1">
                    <span>${it.name || it.item_name || 'Item'}</span>
                    <span class="text-muted">${(it.rarity || '').toString().toUpperCase()}</span>
                </div>
            `).join('');
        }

        async function loadConsumables() {
            const el = document.getElementById('consumables-list');
            const resp = await fetch('/api/trading/gamification/consumables');
            const json = await resp.json();
            if (json.status !== 'success' || !json.data || json.data.count === 0) {
                el.innerHTML = '<div class="text-muted">No consumables. Earn items via trading or games.</div>';
                return;
            }
            el.innerHTML = json.data.items.map(it => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                    <div>
                        <strong>${it.name}</strong> <span class="badge bg-light text-dark">${(it.rarity || '').toString().toUpperCase()}</span>
                        <div class="text-muted small">${it.description || ''}</div>
                    </div>
                    <div>
                        <span class="text-muted me-2">x${it.quantity}</span>
                        <button class="btn btn-sm btn-success" onclick="useConsumable('${it.inventory_id}')">Use</button>
                    </div>
                </div>
            `).join('');
        }

        async function useConsumable(inventoryId) {
            try {
                const resp = await fetch(`/api/trading/gamification/consumables/${inventoryId}/use`, { method: 'POST' });
                const json = await resp.json();
                if (json.status === 'success') {
                    showSuccess(json.data.effect_applied || 'Consumable used');
                    await loadConsumables();
                    await refreshGamificationPanels();
                } else { showError('Failed to use consumable'); }
            } catch (e) { showError('Error using consumable'); }
        }

        async function refreshGamificationPanels() {
            try {
                const walletResponse = await fetch('/api/trading/gamification/wallet');
                const walletJson = await walletResponse.json();
                if (walletJson.status === 'success') { walletData = walletJson.data; updateWalletDisplay(); }
            } catch {}
            try {
                const actResponse = await fetch('/api/trading/gamification/activity');
                const actJson = await actResponse.json();
                if (actJson.status === 'success') { activityData = actJson.data; updateActivityFeed(); }
            } catch {}
            try {
                await loadEffects();
            } catch {}
        }

        let effectsTimer = null;
        async function loadEffects() {
            const el = document.getElementById('effects-list');
            const resp = await fetch('/api/trading/gamification/effects');
            const json = await resp.json();
            if (json.status !== 'success' || !json.data || !json.data.effects || Object.keys(json.data.effects).length === 0) {
                el.innerHTML = '<div class="text-muted">No active effects.</div>';
                updateEffectsBadge(null);
                if (effectsTimer) { clearInterval(effectsTimer); effectsTimer = null; }
                return;
            }
            const effects = Object.values(json.data.effects);
            const rows = effects.map(e => {
                const badge = e.type === 'XP_MULT' ? 'bg-info' : e.type === 'GEM_MULT' ? 'bg-success' : e.type === 'DROP_RATE' ? 'bg-primary' : 'bg-warning';
                const meta = e.remaining_uses ? `${e.remaining_uses} uses` : (e.expires_at ? `<span data-exp="${e.expires_at}"></span>` : '');
                return `<div class="d-flex justify-content-between align-items-center border-bottom py-1">
                    <div><span class="badge ${badge}">${e.type}</span> x${e.multiplier || 1}</div>
                    <div class="text-muted small effect-exp">${meta}</div>
                </div>`;
            }).join('');
            el.innerHTML = rows;
            updateEffectsBadge(effects);
            startEffectsCountdown();
        }

        function updateEffectsBadge(effects) {
            const el = document.getElementById('effects-badge');
            if (!effects || effects.length === 0) { el.innerHTML = ''; return; }
            const types = effects.map(e => e.type);
            const icons = types.map(t => t === 'XP_MULT' ? '<span class="badge bg-info me-1">XP</span>' : t === 'GEM_MULT' ? '<span class="badge bg-success me-1">GEM</span>' : t === 'DROP_RATE' ? '<span class="badge bg-primary me-1">DROP</span>' : '<span class="badge bg-warning text-dark me-1">RARE</span>').join('');
            el.innerHTML = `<div class="text-light small">Effects: ${icons}</div>`;
        }

        function startEffectsCountdown() {
            if (effectsTimer) { clearInterval(effectsTimer); effectsTimer = null; }
            const update = () => {
                const nodes = document.querySelectorAll('#effects-list .effect-exp span[data-exp]');
                const now = Date.now();
                nodes.forEach(node => {
                    const exp = new Date(node.getAttribute('data-exp')).getTime();
                    const diff = Math.max(0, Math.floor((exp - now) / 1000));
                    const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
                    node.textContent = diff > 0 ? `${h}h ${m}m ${s}s` : 'expired';
                });
            };
            update();
            effectsTimer = setInterval(update, 1000);
        }

        function updateActivityFeed() {
            const el = document.getElementById('activity-feed');
            if (!activityData) {
                el.innerHTML = '<div class="text-muted">No activity yet.</div>';
                return;
            }
            let html = '';
            if (activityData.recent_drops && activityData.recent_drops.length) {
                html += '<div class="mb-2"><strong>Recent Item Drops</strong></div>';
                html += activityData.recent_drops.map(d => `
                    <div class="d-flex justify-content-between border-bottom py-1">
                        <span>${d.name}</span>
                        <span class="text-muted">${(d.rarity || '').toString().toUpperCase()}</span>
                    </div>
                `).join('');
            }
            if (activityData.transactions && activityData.transactions.length) {
                html += '<div class="mt-3 mb-2"><strong>Recent Transactions</strong></div>';
                html += activityData.transactions.slice(0, 5).map(t => `
                    <div class="d-flex justify-content-between border-bottom py-1">
                        <span>${t.source || t.type}</span>
                        <span class="text-muted">${t.amount}</span>
                    </div>
                `).join('');
            }
            if (!html) html = '<div class="text-muted">No recent rewards.</div>';
            el.innerHTML = html;
        }

        // Authentication functions
        async function checkAuthenticationState() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showAuthButtons();
                    return;
                }

                // Verify token by calling a protected endpoint
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    showUserMenu(userData.data);
                } else {
                    // Token expired or invalid
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    showAuthButtons();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showAuthButtons();
            }
        }

        function showAuthButtons() {
            document.getElementById('auth-buttons').classList.remove('d-none');
            document.getElementById('user-menu').classList.add('d-none');
        }

        function showUserMenu(userData) {
            document.getElementById('auth-buttons').classList.add('d-none');
            document.getElementById('user-menu').classList.remove('d-none');
            document.getElementById('username-display').textContent = userData.username || 'Player';
        }

        async function logout() {
            try {
                const token = localStorage.getItem('access_token');
                if (token) {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                }
            } catch (error) {
                console.error('Logout failed:', error);
            } finally {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                showAuthButtons();
                showSuccess('Logged out successfully');
            }
        }
    </script>
</body>
</html>
