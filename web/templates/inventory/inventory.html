{% extends "base.html" %}

{% block title %}Inventory - Crypto Gamification Platform{% endblock %}

{% block body_class %}inventory-page{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-effect border-0">
                <div class="card-body text-center py-4">
                    <h1 class="display-5 fw-bold text-white mb-3">
                        <i class="fas fa-briefcase me-3"></i>Virtual Inventory
                    </h1>
                    <p class="lead text-white opacity-75 mb-0">
                        Manage your collectible crypto-themed items and trading cards
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filters & Controls -->
        <div class="col-lg-3 mb-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters & Controls
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    <div class="mb-3">
                        <label for="itemSearch" class="form-label fw-semibold">Search Items</label>
                        <input type="text" class="form-control" id="itemSearch" placeholder="Search by name...">
                    </div>

                    <!-- Rarity Filter -->
                    <div class="mb-3">
                        <label for="rarityFilter" class="form-label fw-semibold">Rarity</label>
                        <select class="form-select" id="rarityFilter">
                            <option value="">All Rarities</option>
                            <option value="COMMON">Common</option>
                            <option value="UNCOMMON">Uncommon</option>
                            <option value="RARE">Rare</option>
                            <option value="EPIC">Epic</option>
                            <option value="LEGENDARY">Legendary</option>
                            <option value="MYTHIC">Mythic</option>
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div class="mb-3">
                        <label for="categoryFilter" class="form-label fw-semibold">Category</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="trading_cards">Trading Cards</option>
                            <option value="accessories">Accessories</option>
                            <option value="consumables">Consumables</option>
                            <option value="special">Special Items</option>
                        </select>
                    </div>

                    <!-- Sort Options -->
                    <div class="mb-3">
                        <label for="sortBy" class="form-label fw-semibold">Sort By</label>
                        <select class="form-select" id="sortBy">
                            <option value="name">Name</option>
                            <option value="rarity">Rarity</option>
                            <option value="quantity">Quantity</option>
                            <option value="obtained_date">Date Obtained</option>
                        </select>
                    </div>

                    <!-- View Options -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">View</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="viewMode" id="gridView" value="grid" checked>
                            <label class="btn btn-outline-primary" for="gridView">
                                <i class="fas fa-th"></i>
                            </label>
                            <input type="radio" class="btn-check" name="viewMode" id="listView" value="list">
                            <label class="btn btn-outline-primary" for="listView">
                                <i class="fas fa-list"></i>
                            </label>
                        </div>
                    </div>

                    <hr>

                    <!-- Quick Actions -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="openItemPack()">
                            <i class="fas fa-box-open me-2"></i>Open Item Pack
                        </button>
                        <button class="btn btn-info" onclick="showTrading()">
                            <i class="fas fa-exchange-alt me-2"></i>Trading Center
                        </button>
                        <button class="btn btn-warning" onclick="showMarketplace()">
                            <i class="fas fa-store me-2"></i>Marketplace
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Grid -->
        <div class="col-lg-9">
            <!-- Stats Bar -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-3">
                            <h4 class="text-primary mb-1" id="totalItems">0</h4>
                            <small class="text-muted">Total Items</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-3">
                            <h4 class="text-success mb-1" id="uniqueItems">0</h4>
                            <small class="text-muted">Unique Items</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-3">
                            <h4 class="text-warning mb-1" id="rareItems">0</h4>
                            <small class="text-muted">Rare+ Items</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-3">
                            <h4 class="text-info mb-1" id="equippedItems">0</h4>
                            <small class="text-muted">Equipped</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items Container -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your Items</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshInventory()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="selectMultiple()">
                            <i class="fas fa-check-square me-1"></i>Select Multiple
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="inventoryContainer">
                        <!-- Items will be loaded here -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-3 text-muted">Loading your inventory...</div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Inventory pagination" class="mt-4">
                        <ul class="pagination justify-content-center" id="inventoryPagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Item Details Modal -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="item-image-large mb-3" id="modalItemImage">
                            <i class="fas fa-gem display-1"></i>
                        </div>
                        <div class="item-actions d-grid gap-2">
                            <button class="btn btn-primary" id="equipItemBtn" onclick="equipItem()">
                                <i class="fas fa-hand-paper me-2"></i>Equip
                            </button>
                            <button class="btn btn-success" id="useItemBtn" onclick="useItem()">
                                <i class="fas fa-magic me-2"></i>Use Item
                            </button>
                            <button class="btn btn-warning" id="tradeItemBtn" onclick="initiateTradeItem()">
                                <i class="fas fa-exchange-alt me-2"></i>Trade
                            </button>
                            <button class="btn btn-danger" id="sellItemBtn" onclick="sellItem()">
                                <i class="fas fa-dollar-sign me-2"></i>Sell
                            </button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="item-details">
                            <h3 id="modalItemName">Item Name</h3>
                            <div class="mb-3">
                                <span class="badge rarity-badge me-2" id="modalItemRarity">Common</span>
                                <span class="badge bg-secondary" id="modalItemCategory">Category</span>
                            </div>
                            <p id="modalItemDescription">Item description goes here.</p>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Quantity:</strong> <span id="modalItemQuantity">1</span>
                                </div>
                                <div class="col-6">
                                    <strong>Stack Size:</strong> <span id="modalItemStackSize">1</span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Tradeable:</strong> <span id="modalItemTradeable">Yes</span>
                                </div>
                                <div class="col-6">
                                    <strong>Market Value:</strong> <span id="modalItemValue">100 GEM</span>
                                </div>
                            </div>

                            <div class="mb-3" id="itemEffectsContainer" style="display: none;">
                                <strong>Effects:</strong>
                                <div id="itemEffects" class="mt-2"></div>
                            </div>

                            <div class="item-history">
                                <strong>Obtained:</strong> <span id="modalItemObtained">Date</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Trading Modal -->
<div class="modal fade" id="tradingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Trading Center
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Active Trades -->
                    <div class="col-lg-6 mb-4">
                        <h6 class="fw-semibold mb-3">Your Active Trades</h6>
                        <div id="activeTradesContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2 text-muted">Loading active trades...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Requests -->
                    <div class="col-lg-6 mb-4">
                        <h6 class="fw-semibold mb-3">Incoming Trade Requests</h6>
                        <div id="tradeRequestsContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2 text-muted">Loading trade requests...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="text-center">
                    <button class="btn btn-primary" onclick="createNewTrade()">
                        <i class="fas fa-plus me-2"></i>Create New Trade
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Item Pack Opening Modal -->
<div class="modal fade" id="itemPackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-box-open me-2"></i>Open Item Pack
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="item-pack-animation mb-4">
                    <div class="item-pack-box" id="itemPackBox">
                        <i class="fas fa-box display-1 text-warning"></i>
                        <div class="mt-2">
                            <strong>Standard Pack</strong>
                            <div class="small text-muted">Contains 5 random items</div>
                        </div>
                    </div>
                </div>

                <div class="pack-options mb-4">
                    <div class="row">
                        <div class="col-4">
                            <div class="card pack-option" data-pack="standard">
                                <div class="card-body text-center py-3">
                                    <i class="fas fa-box text-primary mb-2"></i>
                                    <div class="fw-semibold">Standard</div>
                                    <div class="small text-muted">500 GEM</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card pack-option" data-pack="premium">
                                <div class="card-body text-center py-3">
                                    <i class="fas fa-star text-warning mb-2"></i>
                                    <div class="fw-semibold">Premium</div>
                                    <div class="small text-muted">1,500 GEM</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card pack-option" data-pack="legendary">
                                <div class="card-body text-center py-3">
                                    <i class="fas fa-crown text-danger mb-2"></i>
                                    <div class="fw-semibold">Legendary</div>
                                    <div class="small text-muted">5,000 GEM</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="packResults" class="pack-results" style="display: none;">
                    <h6 class="fw-semibold mb-3">Items Received:</h6>
                    <div class="row" id="packResultsContainer">
                        <!-- Pack results will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="openPackBtn" onclick="openSelectedPack()">
                    <i class="fas fa-box-open me-2"></i>Open Pack
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};
let selectedItems = [];
let isMultiSelectMode = false;
let selectedItemData = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeInventory();
    setupEventListeners();
});

function initializeInventory() {
    loadInventory();
    loadInventoryStats();
}

function setupEventListeners() {
    // Filter changes
    document.getElementById('itemSearch').addEventListener('input', 
        window.utils.debounce(applyFilters, 500));
    document.getElementById('rarityFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('sortBy').addEventListener('change', applyFilters);
    
    // View mode changes
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', changeViewMode);
    });
    
    // Pack selection
    document.querySelectorAll('.pack-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.pack-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
}

async function loadInventory() {
    try {
        showLoading('inventoryContainer');
        
        const params = {
            page: currentPage,
            ...currentFilters
        };
        
        const response = await apiClient.inventory.getItems(
            params.page, 
            params.rarity, 
            params.category
        );
        
        if (response.success) {
            displayInventoryItems(response.data.items);
            updatePagination(response.data.pagination);
        }
    } catch (error) {
        console.error('Failed to load inventory:', error);
        showAlert('Failed to load inventory', 'danger');
    } finally {
        hideLoading('inventoryContainer');
    }
}

function displayInventoryItems(items) {
    const container = document.getElementById('inventoryContainer');
    const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-box-open text-muted display-1 mb-3"></i>
                <h5 class="text-muted">No items found</h5>
                <p class="text-muted">Try adjusting your filters or open some item packs!</p>
                <button class="btn btn-success" onclick="openItemPack()">
                    <i class="fas fa-box-open me-2"></i>Open Item Pack
                </button>
            </div>
        `;
        return;
    }
    
    if (viewMode === 'grid') {
        displayGridView(items);
    } else {
        displayListView(items);
    }
}

function displayGridView(items) {
    const container = document.getElementById('inventoryContainer');
    
    const itemsHTML = items.map(item => `
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
            <div class="item-card ${isMultiSelectMode ? 'selectable' : ''}" 
                 data-item-id="${item.id}" onclick="handleItemClick('${item.id}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                <div class="item-image item-rarity-${item.rarity.toLowerCase()}">
                    ${getItemIcon(item.category)}
                </div>
                <div class="item-details">
                    <h6 class="item-name mb-2">${item.name}</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge rarity-${item.rarity.toLowerCase()}">${item.rarity}</span>
                        <span class="text-muted">×${item.quantity}</span>
                    </div>
                    <p class="item-description small text-muted mb-2">${item.description.substring(0, 80)}${item.description.length > 80 ? '...' : ''}</p>
                    <div class="item-actions">
                        ${item.is_equipped ? '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Equipped</span>' : ''}
                        ${item.is_tradeable ? '<span class="badge bg-info">Tradeable</span>' : ''}
                    </div>
                </div>
                ${isMultiSelectMode ? '<div class="item-select-overlay"><i class="fas fa-check"></i></div>' : ''}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `<div class="row inventory-grid">${itemsHTML}</div>`;
}

function displayListView(items) {
    const container = document.getElementById('inventoryContainer');
    
    const itemsHTML = items.map(item => `
        <div class="item-row ${isMultiSelectMode ? 'selectable' : ''}" 
             data-item-id="${item.id}" onclick="handleItemClick('${item.id}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">
            <div class="row align-items-center py-3">
                <div class="col-md-2">
                    <div class="item-icon item-rarity-${item.rarity.toLowerCase()}">
                        ${getItemIcon(item.category)}
                    </div>
                </div>
                <div class="col-md-4">
                    <h6 class="mb-1">${item.name}</h6>
                    <small class="text-muted">${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}</small>
                </div>
                <div class="col-md-2">
                    <span class="badge rarity-${item.rarity.toLowerCase()}">${item.rarity}</span>
                </div>
                <div class="col-md-1">
                    <span class="fw-semibold">×${item.quantity}</span>
                </div>
                <div class="col-md-2">
                    ${item.is_equipped ? '<span class="badge bg-success">Equipped</span>' : ''}
                    ${item.is_tradeable ? '<span class="badge bg-info">Tradeable</span>' : ''}
                </div>
                <div class="col-md-1">
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showItemDetails('${item.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = itemsHTML;
}

function getItemIcon(category) {
    const icons = {
        'trading_cards': '<i class="fas fa-id-card display-4"></i>',
        'accessories': '<i class="fas fa-ring display-4"></i>',
        'consumables': '<i class="fas fa-flask display-4"></i>',
        'special': '<i class="fas fa-star display-4"></i>'
    };
    return icons[category] || '<i class="fas fa-cube display-4"></i>';
}

function handleItemClick(itemId, itemData) {
    if (isMultiSelectMode) {
        toggleItemSelection(itemId);
    } else {
        showItemDetails(itemId, itemData);
    }
}

function showItemDetails(itemId, itemData = null) {
    if (itemData && typeof itemData === 'string') {
        try {
            itemData = JSON.parse(itemData.replace(/&quot;/g, '"'));
        } catch (e) {
            console.error('Failed to parse item data:', e);
        }
    }
    
    if (!itemData) {
        // Load item details from API
        loadItemDetails(itemId);
        return;
    }
    
    selectedItemData = itemData;
    
    // Populate modal
    document.getElementById('modalItemImage').innerHTML = getItemIcon(itemData.category);
    document.getElementById('modalItemName').textContent = itemData.name;
    document.getElementById('modalItemRarity').textContent = itemData.rarity;
    document.getElementById('modalItemRarity').className = `badge rarity-${itemData.rarity.toLowerCase()}`;
    document.getElementById('modalItemCategory').textContent = itemData.category;
    document.getElementById('modalItemDescription').textContent = itemData.description;
    document.getElementById('modalItemQuantity').textContent = itemData.quantity;
    document.getElementById('modalItemStackSize').textContent = itemData.max_stack_size;
    document.getElementById('modalItemTradeable').textContent = itemData.is_tradeable ? 'Yes' : 'No';
    document.getElementById('modalItemValue').textContent = `${itemData.market_value || 100} GEM`;
    document.getElementById('modalItemObtained').textContent = 
        window.utils.formatDate(itemData.obtained_at || itemData.created_at);
    
    // Show/hide action buttons based on item properties
    document.getElementById('equipItemBtn').style.display = 
        itemData.category === 'accessories' && !itemData.is_equipped ? 'block' : 'none';
    document.getElementById('useItemBtn').style.display = 
        itemData.category === 'consumables' ? 'block' : 'none';
    document.getElementById('tradeItemBtn').style.display = 
        itemData.is_tradeable ? 'block' : 'none';
    
    // Show effects if any
    if (itemData.effect_data && Object.keys(itemData.effect_data).length > 0) {
        document.getElementById('itemEffectsContainer').style.display = 'block';
        const effectsHTML = Object.entries(itemData.effect_data).map(([key, value]) => 
            `<span class="badge bg-info me-1">${key}: ${value}</span>`
        ).join('');
        document.getElementById('itemEffects').innerHTML = effectsHTML;
    } else {
        document.getElementById('itemEffectsContainer').style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('itemDetailsModal'));
    modal.show();
}

async function loadItemDetails(itemId) {
    try {
        const response = await apiClient.inventory.getItem(itemId);
        if (response.success) {
            showItemDetails(itemId, response.data);
        }
    } catch (error) {
        console.error('Failed to load item details:', error);
        showAlert('Failed to load item details', 'danger');
    }
}

async function loadInventoryStats() {
    // This would typically load from API
    // For now, we'll calculate from loaded items
    document.getElementById('totalItems').textContent = '0';
    document.getElementById('uniqueItems').textContent = '0';
    document.getElementById('rareItems').textContent = '0';
    document.getElementById('equippedItems').textContent = '0';
}

function applyFilters() {
    currentFilters = {
        search: document.getElementById('itemSearch').value,
        rarity: document.getElementById('rarityFilter').value,
        category: document.getElementById('categoryFilter').value,
        sort: document.getElementById('sortBy').value
    };
    
    currentPage = 1;
    loadInventory();
}

function changeViewMode() {
    loadInventory();
}

function updatePagination(pagination) {
    const container = document.getElementById('inventoryPagination');
    
    if (!pagination || pagination.total_pages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${pagination.current_page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${pagination.current_page - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === pagination.current_page || 
            i === 1 || 
            i === pagination.total_pages || 
            Math.abs(i - pagination.current_page) <= 2) {
            paginationHTML += `
                <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === pagination.current_page - 3 || i === pagination.current_page + 3) {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${pagination.current_page >= pagination.total_pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${pagination.current_page + 1})">Next</a>
        </li>
    `;
    
    container.innerHTML = paginationHTML;
}

function changePage(page) {
    currentPage = page;
    loadInventory();
}

// Item Actions
async function equipItem() {
    if (!selectedItemData) return;
    
    try {
        const response = await apiClient.inventory.equipItem(selectedItemData.id);
        if (response.success) {
            showAlert('Item equipped successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('itemDetailsModal')).hide();
            loadInventory();
        }
    } catch (error) {
        console.error('Failed to equip item:', error);
        showAlert('Failed to equip item', 'danger');
    }
}

async function useItem() {
    if (!selectedItemData) return;
    
    const quantity = prompt('How many would you like to use?', '1');
    if (!quantity || isNaN(quantity) || quantity <= 0) return;
    
    try {
        const response = await apiClient.inventory.useItem(selectedItemData.id, parseInt(quantity));
        if (response.success) {
            showAlert(`Used ${quantity}x ${selectedItemData.name}!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('itemDetailsModal')).hide();
            loadInventory();
        }
    } catch (error) {
        console.error('Failed to use item:', error);
        showAlert('Failed to use item', 'danger');
    }
}

async function sellItem() {
    if (!selectedItemData) return;
    
    const quantity = prompt('How many would you like to sell?', '1');
    if (!quantity || isNaN(quantity) || quantity <= 0) return;
    
    const confirmSell = confirm(`Sell ${quantity}x ${selectedItemData.name} for ${quantity * (selectedItemData.market_value || 100)} GEM?`);
    if (!confirmSell) return;
    
    try {
        const response = await apiClient.inventory.sellItem(selectedItemData.id, parseInt(quantity));
        if (response.success) {
            showAlert(`Sold ${quantity}x ${selectedItemData.name} for ${response.data.total_value} GEM!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('itemDetailsModal')).hide();
            loadInventory();
        }
    } catch (error) {
        console.error('Failed to sell item:', error);
        showAlert('Failed to sell item', 'danger');
    }
}

function initiateTradeItem() {
    bootstrap.Modal.getInstance(document.getElementById('itemDetailsModal')).hide();
    setTimeout(() => showTrading(), 300);
}

// Trading Functions
function showTrading() {
    const modal = new bootstrap.Modal(document.getElementById('tradingModal'));
    modal.show();
    loadActiveTrades();
    loadTradeRequests();
}

async function loadActiveTrades() {
    try {
        const response = await apiClient.inventory.getTrades('ACTIVE');
        const container = document.getElementById('activeTradesContainer');
        
        if (response.success && response.data.length > 0) {
            const tradesHTML = response.data.map(trade => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Trade #${trade.id.substring(0, 8)}</strong>
                                <div class="small text-muted">with ${trade.other_user.username}</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelTrade('${trade.id}')">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = tradesHTML;
        } else {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-exchange-alt mb-2"></i>
                    <div>No active trades</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load active trades:', error);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load trades</div>';
    }
}

async function loadTradeRequests() {
    try {
        const response = await apiClient.inventory.getTrades('PENDING');
        const container = document.getElementById('tradeRequestsContainer');
        
        if (response.success && response.data.length > 0) {
            const requestsHTML = response.data.map(trade => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>From ${trade.other_user.username}</strong>
                                <div class="small text-muted">${trade.offered_items.length} items offered</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-1" onclick="respondToTrade('${trade.id}', 'ACCEPT')">
                                    Accept
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="respondToTrade('${trade.id}', 'DECLINE')">
                                    Decline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = requestsHTML;
        } else {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-inbox mb-2"></i>
                    <div>No pending requests</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load trade requests:', error);
    }
}

async function respondToTrade(tradeId, action) {
    try {
        const response = await apiClient.inventory.respondToTrade(tradeId, action);
        if (response.success) {
            showAlert(`Trade ${action.toLowerCase()}ed successfully!`, 'success');
            loadActiveTrades();
            loadTradeRequests();
        }
    } catch (error) {
        console.error('Failed to respond to trade:', error);
        showAlert('Failed to respond to trade', 'danger');
    }
}

async function cancelTrade(tradeId) {
    if (!confirm('Are you sure you want to cancel this trade?')) return;
    
    try {
        const response = await apiClient.inventory.cancelTrade(tradeId);
        if (response.success) {
            showAlert('Trade cancelled successfully!', 'success');
            loadActiveTrades();
        }
    } catch (error) {
        console.error('Failed to cancel trade:', error);
        showAlert('Failed to cancel trade', 'danger');
    }
}

function createNewTrade() {
    showAlert('Trade creation interface coming soon!', 'info');
}

// Item Pack Functions
function openItemPack() {
    const modal = new bootstrap.Modal(document.getElementById('itemPackModal'));
    modal.show();
    
    // Reset pack selection
    document.querySelectorAll('.pack-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector('.pack-option[data-pack="standard"]').classList.add('selected');
    document.getElementById('packResults').style.display = 'none';
}

async function openSelectedPack() {
    const selectedPack = document.querySelector('.pack-option.selected');
    if (!selectedPack) {
        showAlert('Please select a pack to open', 'warning');
        return;
    }
    
    const packType = selectedPack.dataset.pack;
    const packCosts = { standard: 500, premium: 1500, legendary: 5000 };
    
    if (!confirm(`Open ${packType} pack for ${packCosts[packType]} GEM?`)) {
        return;
    }
    
    document.getElementById('openPackBtn').disabled = true;
    
    // Simulate pack opening animation
    const packBox = document.getElementById('itemPackBox');
    packBox.classList.add('opening');
    
    setTimeout(() => {
        showPackResults(packType);
        packBox.classList.remove('opening');
        document.getElementById('openPackBtn').disabled = false;
    }, 2000);
}

function showPackResults(packType) {
    // Simulate pack results
    const mockResults = [
        { name: 'Bitcoin Card', rarity: 'RARE', category: 'trading_cards' },
        { name: 'Ethereum Pendant', rarity: 'UNCOMMON', category: 'accessories' },
        { name: 'Energy Potion', rarity: 'COMMON', category: 'consumables' },
        { name: 'Dogecoin Sticker', rarity: 'COMMON', category: 'trading_cards' },
        { name: 'Crypto Dust', rarity: 'UNCOMMON', category: 'consumables' }
    ];
    
    const resultsContainer = document.getElementById('packResultsContainer');
    const resultsHTML = mockResults.map(item => `
        <div class="col-4 mb-3">
            <div class="card item-card item-rarity-${item.rarity.toLowerCase()}">
                <div class="card-body text-center p-2">
                    ${getItemIcon(item.category)}
                    <div class="mt-2">
                        <strong class="small">${item.name}</strong>
                        <div class="badge rarity-${item.rarity.toLowerCase()} mt-1">${item.rarity}</div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    resultsContainer.innerHTML = resultsHTML;
    document.getElementById('packResults').style.display = 'block';
    
    showAlert(`Pack opened! You received ${mockResults.length} items.`, 'success');
}

// Utility Functions
function refreshInventory() {
    loadInventory();
    loadInventoryStats();
}

function selectMultiple() {
    isMultiSelectMode = !isMultiSelectMode;
    const btn = event.target.closest('button');
    
    if (isMultiSelectMode) {
        btn.innerHTML = '<i class="fas fa-times me-1"></i>Cancel Selection';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-danger');
        showAlert('Multi-select mode enabled. Click items to select them.', 'info');
    } else {
        btn.innerHTML = '<i class="fas fa-check-square me-1"></i>Select Multiple';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-outline-success');
        selectedItems = [];
        document.querySelectorAll('.item-card.selected, .item-row.selected').forEach(item => {
            item.classList.remove('selected');
        });
    }
    
    loadInventory();
}

function toggleItemSelection(itemId) {
    const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!itemElement) return;
    
    if (selectedItems.includes(itemId)) {
        selectedItems = selectedItems.filter(id => id !== itemId);
        itemElement.classList.remove('selected');
    } else {
        selectedItems.push(itemId);
        itemElement.classList.add('selected');
    }
    
    console.log('Selected items:', selectedItems);
}

function showMarketplace() {
    showAlert('Marketplace coming soon!', 'info');
}
</script>

<style>
.rarity-common { background-color: #9ca3af !important; }
.rarity-uncommon { background-color: #22c55e !important; }
.rarity-rare { background-color: #3b82f6 !important; }
.rarity-epic { background-color: #a855f7 !important; }
.rarity-legendary { background-color: #f59e0b !important; }
.rarity-mythic { background-color: #ef4444 !important; }

.pack-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.pack-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.pack-option.selected {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
}

.item-pack-box.opening {
    animation: shake 0.5s ease-in-out infinite;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.item-card.selectable {
    position: relative;
    cursor: pointer;
}

.item-select-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    background: var(--bs-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.item-card.selected .item-select-overlay {
    opacity: 1;
}

.item-row.selectable {
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.item-row.selected {
    background-color: rgba(13, 110, 253, 0.1);
}
</style>
{% endblock %}