{% extends "base.html" %}
{% block title %}Balance Persistence Test - CryptoChecker{% endblock %}

{% block extra_css %}
<style>
.test-container {
    background: rgba(0, 0, 0, 0.8);
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
    border: 2px solid #fbbf24;
}

.test-result {
    padding: 10px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.test-pass {
    background: rgba(34, 197, 94, 0.1);
    border-color: #22c55e;
    color: #22c55e;
}

.test-fail {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}

.test-pending {
    background: rgba(245, 158, 11, 0.1);
    border-color: #f59e0b;
    color: #f59e0b;
}

.balance-display {
    font-size: 2rem;
    font-weight: bold;
    color: #fbbf24;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.test-button {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    border: none;
    color: #000;
    font-weight: bold;
    padding: 12px 24px;
    border-radius: 8px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.test-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
}

.console-output {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    max-height: 400px;
    overflow-y: auto;
    color: #00ff00;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-pass { background-color: #22c55e; }
.status-fail { background-color: #ef4444; }
.status-pending { background-color: #f59e0b; }

.refresh-warning {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid #ef4444;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    color: #ef4444;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 pt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="text-warning mb-3">
                    <i class="fas fa-flask me-3"></i>Balance Persistence Test
                </h1>
                <p class="text-light lead">
                    Test the demo balance persistence fix across page refreshes
                </p>
            </div>

            <!-- Current Balance Display -->
            <div class="test-container text-center">
                <h3 class="text-warning mb-3">Current Demo Balance</h3>
                <div class="balance-display" id="currentBalanceDisplay">
                    <i class="fas fa-gem me-2"></i>
                    <span id="balanceAmount">Loading...</span> GEM
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        Mode: <span id="modeIndicator" class="text-warning">Detecting...</span>
                    </small>
                </div>
            </div>

            <!-- Test Controls -->
            <div class="test-container">
                <h4 class="text-warning mb-3">
                    <i class="fas fa-cogs me-2"></i>Test Controls
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-light mb-3">Balance Operations</h5>
                        <button class="test-button" onclick="setBalance(2500)">
                            Set Balance to 2,500 GEM
                        </button>
                        <button class="test-button" onclick="setBalance(7777)">
                            Set Balance to 7,777 GEM
                        </button>
                        <button class="test-button" onclick="setRandomBalance()">
                            Set Random Balance
                        </button>
                        <button class="test-button" onclick="resetBalance()">
                            Reset to Default (5,000 GEM)
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="text-light mb-3">Persistence Tests</h5>
                        <button class="test-button" onclick="testLocalPersistence()">
                            Test localStorage Persistence
                        </button>
                        <button class="test-button" onclick="testServerPersistence()">
                            Test Server Persistence
                        </button>
                        <button class="test-button" onclick="runFullTest()">
                            <i class="fas fa-play me-2"></i>Run Full Test
                        </button>
                        <button class="test-button" onclick="clearAllData()">
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Refresh Test Warning -->
            <div class="refresh-warning">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Manual Refresh Test</h5>
                <p class="mb-2">
                    To test balance persistence, change your balance above, then refresh this page (F5 or Ctrl+R).
                    Your balance should remain the same after refresh.
                </p>
                <button class="btn btn-outline-danger" onclick="location.reload()">
                    <i class="fas fa-sync me-2"></i>Refresh Page Now
                </button>
            </div>

            <!-- Test Results -->
            <div class="test-container">
                <h4 class="text-warning mb-3">
                    <i class="fas fa-check-circle me-2"></i>Test Results
                </h4>
                <div id="testResults">
                    <div class="test-result test-pending">
                        <span class="status-indicator status-pending"></span>
                        Click "Run Full Test" to begin automated testing
                    </div>
                </div>
            </div>

            <!-- Console Output -->
            <div class="test-container">
                <h4 class="text-warning mb-3">
                    <i class="fas fa-terminal me-2"></i>Console Output
                </h4>
                <div class="console-output" id="consoleOutput">
                    <div>üéØ Balance Persistence Test Console</div>
                    <div>Waiting for balance manager initialization...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Test Suite Implementation
class BalancePersistenceTestUI {
    constructor() {
        this.testResults = [];
        this.currentBalance = 0;
        this.consoleOutput = document.getElementById('consoleOutput');
        this.balanceDisplay = document.getElementById('balanceAmount');
        this.modeIndicator = document.getElementById('modeIndicator');
        
        this.init();
    }
    
    async init() {
        this.log('üîÑ Initializing Balance Persistence Test UI');
        
        // Wait for balance manager
        await this.waitForBalanceManager();
        
        // Setup balance monitoring
        this.setupBalanceMonitoring();
        
        // Initial balance load
        this.updateBalanceDisplay();
        
        this.log('‚úÖ Test UI initialized successfully');
    }
    
    async waitForBalanceManager() {
        return new Promise((resolve) => {
            const check = () => {
                if (window.balanceManager) {
                    this.log('‚úÖ Balance Manager found');
                    resolve();
                } else {
                    setTimeout(check, 100);
                }
            };
            check();
        });
    }
    
    setupBalanceMonitoring() {
        // Listen for balance changes
        window.balanceManager.addBalanceListener((event) => {
            this.currentBalance = event.balance;
            this.updateBalanceDisplay();
            this.log(`üí∞ Balance updated: ${event.balance} GEM (${event.type})`);
        });
        
        // Initial balance
        this.currentBalance = window.balanceManager.getBalance();
        this.updateBalanceDisplay();
    }
    
    updateBalanceDisplay() {
        if (this.balanceDisplay) {
            this.balanceDisplay.textContent = this.currentBalance.toLocaleString();
        }
        
        if (this.modeIndicator && window.balanceManager) {
            const isDemo = window.balanceManager.isInDemoMode();
            const isAuth = window.balanceManager.isUserAuthenticated();
            this.modeIndicator.textContent = isDemo ? 'Demo Mode' : 'Authenticated';
            this.modeIndicator.className = isDemo ? 'text-warning' : 'text-success';
        }
    }
    
    log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${timestamp}] ${message}`;
        this.consoleOutput.appendChild(logEntry);
        this.consoleOutput.scrollTop = this.consoleOutput.scrollHeight;
        console.log(message);
    }
    
    async setBalance(amount) {
        this.log(`üéØ Setting balance to ${amount} GEM`);
        try {
            await window.balanceManager.updateBalance(amount, 'manual_test');
            this.log(`‚úÖ Balance set successfully`);
        } catch (error) {
            this.log(`‚ùå Failed to set balance: ${error.message}`);
        }
    }
    
    async setRandomBalance() {
        const randomAmount = Math.floor(Math.random() * 10000) + 1000;
        await this.setBalance(randomAmount);
    }
    
    async resetBalance() {
        await this.setBalance(5000);
    }
    
    async testLocalPersistence() {
        this.log('üß™ Testing localStorage persistence...');
        
        // Set a test balance
        const testBalance = 6543;
        await this.setBalance(testBalance);
        
        // Check localStorage directly
        const storedValue = localStorage.getItem('cc_demo_balance_v2');
        const parsedValue = parseFloat(storedValue);
        
        const passed = parsedValue === testBalance;
        this.addTestResult('localStorage Persistence', passed, 
            `Stored: ${storedValue}, Expected: ${testBalance}`);
    }
    
    async testServerPersistence() {
        this.log('üß™ Testing server persistence...');
        
        const testBalance = 8888;
        
        try {
            // Save to server
            await this.setBalance(testBalance);
            
            // Test server sync
            const response = await fetch('/api/gaming/roulette/sync_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'restore' })
            });
            
            const data = await response.json();
            const serverBalance = data.data?.balance;
            
            const passed = serverBalance === testBalance;
            this.addTestResult('Server Persistence', passed,
                `Server returned: ${serverBalance}, Expected: ${testBalance}`);
                
        } catch (error) {
            this.addTestResult('Server Persistence', false, `Error: ${error.message}`);
        }
    }
    
    async runFullTest() {
        this.log('üöÄ Running full persistence test suite...');
        this.clearTestResults();
        
        // Test 1: Basic balance update
        await this.testBasicBalanceUpdate();
        
        // Test 2: localStorage persistence
        await this.testLocalPersistence();
        
        // Test 3: Server persistence
        await this.testServerPersistence();
        
        // Test 4: Cross-tab persistence (simulated)
        await this.testCrossTabPersistence();
        
        // Test 5: Page refresh simulation
        await this.testPageRefreshSimulation();
        
        this.log('‚úÖ Full test suite completed');
    }
    
    async testBasicBalanceUpdate() {
        this.log('üß™ Testing basic balance update...');
        
        const initialBalance = this.currentBalance;
        const testBalance = 4321;
        
        await this.setBalance(testBalance);
        
        const passed = this.currentBalance === testBalance;
        this.addTestResult('Basic Balance Update', passed,
            `Updated from ${initialBalance} to ${this.currentBalance}`);
    }
    
    async testCrossTabPersistence() {
        this.log('üß™ Testing cross-tab persistence simulation...');
        
        const testBalance = 9999;
        await this.setBalance(testBalance);
        
        // Simulate storage event (cross-tab communication)
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'cc_demo_balance_v2',
            newValue: testBalance.toString(),
            oldValue: this.currentBalance.toString()
        }));
        
        // Small delay to let event handlers process
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const passed = this.currentBalance === testBalance;
        this.addTestResult('Cross-Tab Persistence (Simulated)', passed,
            `Balance after storage event: ${this.currentBalance}`);
    }
    
    async testPageRefreshSimulation() {
        this.log('üß™ Testing page refresh simulation...');
        
        const testBalance = 1234;
        await this.setBalance(testBalance);
        
        // Simulate balance manager reload
        const storedBalance = localStorage.getItem('cc_demo_balance_v2');
        const restoredBalance = parseFloat(storedBalance);
        
        const passed = !isNaN(restoredBalance) && restoredBalance === testBalance;
        this.addTestResult('Page Refresh Simulation', passed,
            `Would restore balance: ${restoredBalance} from localStorage`);
    }
    
    addTestResult(testName, passed, details) {
        const result = { testName, passed, details, timestamp: new Date() };
        this.testResults.push(result);
        
        const resultsContainer = document.getElementById('testResults');
        const resultElement = document.createElement('div');
        resultElement.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
        resultElement.innerHTML = `
            <span class="status-indicator ${passed ? 'status-pass' : 'status-fail'}"></span>
            <strong>${testName}</strong>: ${details}
        `;
        
        resultsContainer.appendChild(resultElement);
        this.log(`${passed ? '‚úÖ' : '‚ùå'} ${testName}: ${details}`);
    }
    
    clearTestResults() {
        this.testResults = [];
        const resultsContainer = document.getElementById('testResults');
        resultsContainer.innerHTML = '<div class="test-result test-pending"><span class="status-indicator status-pending"></span>Running tests...</div>';
    }
    
    clearAllData() {
        this.log('üóëÔ∏è  Clearing all persistence data...');
        
        // Clear localStorage
        localStorage.removeItem('cc_demo_balance_v2');
        localStorage.removeItem('cc_balance_timestamp');
        
        // Clear cookies
        document.cookie = 'cc_demo_balance=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        document.cookie = 'cc_demo_balance_updated=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        
        // Reset balance manager
        if (window.balanceManager) {
            window.balanceManager.updateBalance(5000, 'data_clear');
        }
        
        this.log('‚úÖ All data cleared, balance reset to 5000 GEM');
    }
}

// Global functions for button handlers
window.setBalance = async (amount) => {
    if (window.testUI) {
        await window.testUI.setBalance(amount);
    }
};

window.setRandomBalance = async () => {
    if (window.testUI) {
        await window.testUI.setRandomBalance();
    }
};

window.resetBalance = async () => {
    if (window.testUI) {
        await window.testUI.resetBalance();
    }
};

window.testLocalPersistence = async () => {
    if (window.testUI) {
        await window.testUI.testLocalPersistence();
    }
};

window.testServerPersistence = async () => {
    if (window.testUI) {
        await window.testUI.testServerPersistence();
    }
};

window.runFullTest = async () => {
    if (window.testUI) {
        await window.testUI.runFullTest();
    }
};

window.clearAllData = () => {
    if (window.testUI) {
        window.testUI.clearAllData();
    }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.testUI = new BalancePersistenceTestUI();
});
</script>
{% endblock %}