{% extends "base.html" %}

{% block title %}Social Hub - CryptoChecker Gaming Platform{% endblock %}

{% block body_class %}social-page{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-effect border-0">
                <div class="card-body text-center py-4">
                    <h1 class="display-5 fw-bold text-white mb-3">
                        <i class="fas fa-users me-3"></i>Social Hub
                    </h1>
                    <p class="lead text-white opacity-75 mb-0">
                        Connect with friends, compete on leaderboards, and share your achievements
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-lg-3 mb-4">
            <!-- Quick Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Your Social Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-value text-primary" id="friendsCount">0</div>
                            <div class="stat-label">Friends</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-value text-success" id="onlineFriendsCount">0</div>
                            <div class="stat-label">Online</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-value text-warning" id="globalRank">-</div>
                            <div class="stat-label">Global Rank</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-value text-info" id="achievementsShared">0</div>
                            <div class="stat-label">Shared</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="showAddFriend()">
                            <i class="fas fa-user-plus me-2"></i>Add Friend
                        </button>
                        <button class="btn btn-success" onclick="updateStatus()">
                            <i class="fas fa-comment me-2"></i>Update Status
                        </button>
                        <button class="btn btn-info" onclick="sendGift()">
                            <i class="fas fa-gift me-2"></i>Send Gift
                        </button>
                        <button class="btn btn-warning" onclick="shareAchievement()">
                            <i class="fas fa-share me-2"></i>Share Achievement
                        </button>
                        <button class="btn btn-outline-secondary" id="nudgeBotsBtn">
                            <i class="fas fa-robot me-2"></i>Show Demo Requests
                        </button>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="allowBotsSwitch" checked>
                            <label class="form-check-label" for="allowBotsSwitch">Allow bot friend requests</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Update -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Your Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img src="/static/images/default-avatar.png" class="rounded-circle me-3" width="50" height="50" id="userStatusAvatar">
                        <div class="flex-grow-1">
                            <div class="fw-semibold" id="userStatusName">Your Name</div>
                            <small class="text-success">
                                <i class="fas fa-circle me-1"></i>Online
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="fw-semibold mb-1">Current Status:</div>
                        <div class="text-muted" id="currentStatus">Ready to game!</div>
                    </div>
                    <div class="mb-3">
                        <div class="fw-semibold mb-1">Mood:</div>
                        <span class="badge bg-primary" id="currentMood">HAPPY</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Navigation Tabs -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="friends-tab" data-bs-toggle="tab" 
                                    data-bs-target="#friends-pane" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>Friends
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" 
                                    data-bs-target="#activity-pane" type="button" role="tab">
                                <i class="fas fa-stream me-2"></i>Activity Feed
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="leaderboards-tab" data-bs-toggle="tab" 
                                    data-bs-target="#leaderboards-pane" type="button" role="tab">
                                <i class="fas fa-trophy me-2"></i>Leaderboards
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gifts-tab" data-bs-toggle="tab" 
                                    data-bs-target="#gifts-pane" type="button" role="tab">
                                <i class="fas fa-gift me-2"></i>Gifts
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Friends Tab -->
                        <div class="tab-pane fade show active" id="friends-pane" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="friendSearch" placeholder="Search friends...">
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="friendFilter">
                                        <option value="">All Friends</option>
                                        <option value="online">Online Only</option>
                                        <option value="recently_active">Recently Active</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Friend Requests -->
                            <div class="mb-4" id="friendRequestsSection">
                                <h6 class="fw-semibold mb-3">
                                    <i class="fas fa-user-clock me-2"></i>Friend Requests
                                    <span class="badge bg-warning ms-2" id="friendRequestsCount">0</span>
                                </h6>
                                <div id="friendRequestsList">
                                    <!-- Friend requests will be loaded here -->
                                </div>
                            </div>

                            <!-- Friends List -->
                            <div>
                                <h6 class="fw-semibold mb-3">
                                    <i class="fas fa-users me-2"></i>Your Friends
                                </h6>
                                <div id="friendsList">
                                    <!-- Friends will be loaded here -->
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <div class="mt-3 text-muted">Loading friends...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Feed Tab -->
                        <div class="tab-pane fade" id="activity-pane" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-semibold mb-0">Recent Activity</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivityFeed()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="activityFeed">
                                <!-- Activity feed will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <div class="mt-3 text-muted">Loading activity feed...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Leaderboards Tab -->
                        <div class="tab-pane fade" id="leaderboards-pane" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="leaderboardType">
                                        <option value="level">Level Rankings</option>
                                        <option value="experience">Experience Points</option>
                                        <option value="games_won">Games Won</option>
                                        <option value="total_winnings">Total Winnings</option>
                                        <option value="win_streak">Win Streak</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-end">
                                        <button class="btn btn-sm btn-info me-2" onclick="showMyRank()">
                                            <i class="fas fa-search me-1"></i>Find My Rank
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="refreshLeaderboard()">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="leaderboardContainer">
                                <!-- Leaderboard will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <div class="mt-3 text-muted">Loading leaderboard...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Gifts Tab -->
                        <div class="tab-pane fade" id="gifts-pane" role="tabpanel">
                            <div class="row">
                                <!-- Send Gifts -->
                                <div class="col-lg-6 mb-4">
                                    <h6 class="fw-semibold mb-3">Send Gifts</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <form id="sendGiftForm">
                                                <div class="mb-3">
                                                    <label class="form-label">Select Friend</label>
                                                    <select class="form-select" id="giftRecipient" required>
                                                        <option value="">Choose a friend...</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Gift Type</label>
                                                    <select class="form-select" id="giftType" required>
                                                        <option value="GEM_COINS">GEM Coins</option>
                                                        <option value="VIRTUAL_CRYPTO">Virtual Crypto</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Amount</label>
                                                    <input type="number" class="form-control" id="giftAmount" 
                                                           min="10" max="1000" value="100" required>
                                                    <div class="form-text">Min: 10, Max: 1,000</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Message (Optional)</label>
                                                    <textarea class="form-control" id="giftMessage" rows="3" 
                                                              placeholder="Add a personal message..."></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-success w-100">
                                                    <i class="fas fa-gift me-2"></i>Send Gift
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Received Gifts -->
                                <div class="col-lg-6 mb-4">
                                    <h6 class="fw-semibold mb-3">Received Gifts</h6>
                                    <div id="receivedGifts">
                                        <!-- Received gifts will be loaded here -->
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <div class="mt-2 text-muted">Loading gifts...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Friend Modal -->
<div class="modal fade" id="addFriendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Add Friend
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFriendForm">
                    <div class="mb-3">
                        <label for="friendUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="friendUsername" 
                               placeholder="Enter username..." required>
                    </div>
                    <div class="mb-3">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter the exact username of the player you want to add as a friend.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendFriendRequest()">
                    <i class="fas fa-paper-plane me-2"></i>Send Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comment me-2"></i>Update Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <div class="mb-3">
                        <label for="statusMessage" class="form-label">Status Message</label>
                        <input type="text" class="form-control" id="statusMessage" 
                               placeholder="What's on your mind?" maxlength="100" required>
                        <div class="form-text">Maximum 100 characters</div>
                    </div>
                    <div class="mb-3">
                        <label for="statusMood" class="form-label">Mood</label>
                        <select class="form-select" id="statusMood">
                            <option value="HAPPY">😊 Happy</option>
                            <option value="EXCITED">🎉 Excited</option>
                            <option value="FOCUSED">🎯 Focused</option>
                            <option value="RELAXED">😌 Relaxed</option>
                            <option value="SAD">😢 Sad</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatus()">
                    <i class="fas fa-save me-2"></i>Update Status
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentLeaderboardType = 'level';
let friendsData = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeSocialHub();
    setupEventListeners();
});

function initializeSocialHub() {
    loadSocialStats();
    loadFriends();
    loadFriendRequests();
    loadActivityFeed();
    loadLeaderboard();
    loadReceivedGifts();
    loadUserStatus();
    populateGiftRecipients();
    loadBotsSettings();
}

function setupEventListeners() {
    // Tab changes
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const target = event.target.getAttribute('data-bs-target');
            if (target === '#leaderboards-pane') {
                loadLeaderboard();
            } else if (target === '#activity-pane') {
                loadActivityFeed();
            }
        });
    });

    // Leaderboard type change
    document.getElementById('leaderboardType').addEventListener('change', function() {
        currentLeaderboardType = this.value;
        loadLeaderboard();
    });

    // Friend search
    document.getElementById('friendSearch').addEventListener('input', 
        window.utils.debounce(filterFriends, 300));
    
    // Friend filter
    document.getElementById('friendFilter').addEventListener('change', filterFriends);

    // Send gift form
    document.getElementById('sendGiftForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitGift();
    });

    // Add friend form
    document.getElementById('addFriendForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendFriendRequest();
    });

    // Update status form
    document.getElementById('updateStatusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveStatus();
    });

    // Bots controls
    const allowSwitch = document.getElementById('allowBotsSwitch');
    const nudgeBtn = document.getElementById('nudgeBotsBtn');
    if (nudgeBtn) {
        nudgeBtn.addEventListener('click', async () => {
            try {
                const r = await fetch('/api/social/bots/nudge', { method: 'POST' });
                const d = await r.json();
                if (d.status === 'success') {
                    loadFriendRequests();
                } else {
                    alert(d.message || 'Failed to nudge bots');
                }
            } catch (e) { alert('Failed to nudge bots'); }
        });
    }
    if (allowSwitch) {
        allowSwitch.addEventListener('change', async () => {
            try {
                const r = await fetch('/api/social/bots/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ allow_bots: allowSwitch.checked }) });
                const d = await r.json();
                if (d.status !== 'success') alert(d.message || 'Failed to update setting');
            } catch(e) { alert('Failed to update setting'); }
        });
    }
}

async function loadBotsSettings(){
    try {
        const r = await fetch('/api/social/bots/settings');
        const d = await r.json();
        if (d.status === 'success' && d.data) {
            const sw = document.getElementById('allowBotsSwitch');
            if (sw) sw.checked = !!d.data.allow_bots;
        }
    } catch (e) { /* ignore */ }
}

async function loadSocialStats() {
    try {
        const response = await apiClient.social.getSocialStats();
        if (response.success) {
            const stats = response.data;
            document.getElementById('friendsCount').textContent = stats.total_friends || 0;
            document.getElementById('onlineFriendsCount').textContent = stats.online_friends || 0;
            document.getElementById('globalRank').textContent = stats.global_rank || '-';
            document.getElementById('achievementsShared').textContent = stats.achievements_shared || 0;
        }
    } catch (error) {
        console.error('Failed to load social stats:', error);
    }
}

async function loadFriends() {
    try {
        const response = await apiClient.social.getFriends();
        if (response.success) {
            friendsData = response.data;
            displayFriends(friendsData);
        }
    } catch (error) {
        console.error('Failed to load friends:', error);
        document.getElementById('friendsList').innerHTML = 
            '<div class="text-center py-4 text-danger">Failed to load friends</div>';
    }
}

function displayFriends(friends) {
    const container = document.getElementById('friendsList');
    
    if (friends.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-user-friends text-muted display-4 mb-3"></i>
                <h5 class="text-muted">No friends yet</h5>
                <p class="text-muted">Start by adding some friends to see them here!</p>
                <button class="btn btn-primary" onclick="showAddFriend()">
                    <i class="fas fa-user-plus me-2"></i>Add Friends
                </button>
            </div>
        `;
        return;
    }

    const friendsHTML = friends.map(friend => `
        <div class="friend-card">
            <img src="${friend.avatar_url || '/static/images/default-avatar.png'}" 
                 class="friend-avatar" alt="${friend.display_name}">
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${friend.display_name || friend.username}</h6>
                        <small class="friend-status ${friend.is_online ? 'online' : 'offline'}">
                            <i class="fas fa-circle me-1"></i>
                            ${friend.is_online ? 'Online' : 'Last active: ' + window.utils.formatRelativeTime(friend.last_active)}
                        </small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="sendMessage('${friend.id}')">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="sendGiftToFriend('${friend.id}')">
                            <i class="fas fa-gift"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFriend('${friend.id}')">
                            <i class="fas fa-user-times"></i>
                        </button>
                    </div>
                </div>
                ${friend.status ? `<div class="small text-muted mt-1">"${friend.status}"</div>` : ''}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = friendsHTML;
}

async function loadFriendRequests() {
    try {
        const response = await apiClient.social.getFriendRequests();
        if (response.success) {
            const requests = response.data;
            document.getElementById('friendRequestsCount').textContent = requests.length;
            
            if (requests.length === 0) {
                document.getElementById('friendRequestsSection').style.display = 'none';
                return;
            }
            
            document.getElementById('friendRequestsSection').style.display = 'block';
            
            const requestsHTML = requests.map(request => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <img src="${request.from_user.avatar_url || '/static/images/default-avatar.png'}" 
                                 class="rounded-circle me-3" width="40" height="40">
                            <div class="flex-grow-1">
                                <div class="fw-semibold">${request.from_user.display_name || request.from_user.username}</div>
                                <small class="text-muted">Sent ${window.utils.formatRelativeTime(request.created_at)}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-2" 
                                        onclick="respondToFriendRequest('${request.id}', 'ACCEPT')">
                                    Accept
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="respondToFriendRequest('${request.id}', 'DECLINE')">
                                    Decline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('friendRequestsList').innerHTML = requestsHTML;
        }
    } catch (error) {
        console.error('Failed to load friend requests:', error);
    }
}

async function loadActivityFeed() {
    try {
        const response = await apiClient.social.getActivityFeed(20);
        const container = document.getElementById('activityFeed');
        
        if (response.success && response.data.length > 0) {
            const activitiesHTML = response.data.map(activity => `
                <div class="activity-item d-flex align-items-start mb-3 p-3 border rounded">
                    <img src="${activity.user.avatar_url || '/static/images/default-avatar.png'}" 
                         class="rounded-circle me-3" width="40" height="40">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-semibold">${activity.user.display_name || activity.user.username}</div>
                                <div class="text-muted">${getActivityDescription(activity)}</div>
                            </div>
                            <small class="text-muted">${window.utils.formatRelativeTime(activity.timestamp)}</small>
                        </div>
                        ${getActivityDetails(activity)}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = activitiesHTML;
        } else {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-stream text-muted display-4 mb-3"></i>
                    <h5 class="text-muted">No recent activity</h5>
                    <p class="text-muted">Activity from your friends will appear here!</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load activity feed:', error);
        document.getElementById('activityFeed').innerHTML = 
            '<div class="text-center py-4 text-danger">Failed to load activity feed</div>';
    }
}

function getActivityDescription(activity) {
    switch (activity.activity_type) {
        case 'game_won':
            return `won a game and earned ${window.utils.formatCurrency(activity.content.winnings)}`;
        case 'achievement_unlocked':
            return `unlocked achievement: ${activity.content.achievement_name}`;
        case 'level_up':
            return `reached level ${activity.content.new_level}`;
        case 'friend_added':
            return `became friends with ${activity.content.friend_name}`;
        case 'item_obtained':
            return `obtained ${activity.content.item_name}`;
        case 'status_update':
            return `updated their status: "${activity.content.status}"`;
        default:
            return 'had some activity';
    }
}

function getActivityDetails(activity) {
    if (activity.activity_type === 'achievement_unlocked') {
        return `
            <div class="mt-2 p-2 bg-light rounded">
                <i class="fas fa-medal text-warning me-2"></i>
                <small class="text-muted">${activity.content.achievement_description || 'Achievement unlocked!'}</small>
            </div>
        `;
    }
    return '';
}

async function loadLeaderboard() {
    try {
        const response = await apiClient.social.getLeaderboard(currentLeaderboardType, 50);
        const container = document.getElementById('leaderboardContainer');
        
        if (response.success && response.data.length > 0) {
            const leaderboardHTML = response.data.map((entry, index) => `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank ${getRankClass(entry.rank)}">#${entry.rank}</div>
                    <img src="${entry.user.avatar_url || '/static/images/default-avatar.png'}" 
                         class="rounded-circle me-3" width="40" height="40">
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${entry.user.display_name || entry.user.username}</div>
                        <small class="text-muted">Level ${entry.user.current_level || 1}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">${formatLeaderboardScore(entry.score, currentLeaderboardType)}</div>
                        ${entry.change_from_yesterday ? `
                            <small class="text-${entry.change_from_yesterday > 0 ? 'success' : 'danger'}">
                                ${entry.change_from_yesterday > 0 ? '↑' : '↓'} ${Math.abs(entry.change_from_yesterday)}
                            </small>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = leaderboardHTML;
        } else {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-trophy text-muted display-4 mb-3"></i>
                    <h5 class="text-muted">No leaderboard data</h5>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load leaderboard:', error);
        document.getElementById('leaderboardContainer').innerHTML = 
            '<div class="text-center py-4 text-danger">Failed to load leaderboard</div>';
    }
}

function getRankClass(rank) {
    if (rank === 1) return 'first';
    if (rank === 2) return 'second';  
    if (rank === 3) return 'third';
    return '';
}

function formatLeaderboardScore(score, type) {
    switch (type) {
        case 'level':
            return `Level ${Math.floor(score)}`;
        case 'experience':
            return `${window.utils.formatNumber(score)} XP`;
        case 'games_won':
            return `${window.utils.formatNumber(score)} Wins`;
        case 'total_winnings':
            return window.utils.formatCurrency(score);
        case 'win_streak':
            return `${Math.floor(score)} Streak`;
        default:
            return window.utils.formatNumber(score);
    }
}

async function loadReceivedGifts() {
    try {
        const response = await apiClient.social.getReceivedGifts(10);
        const container = document.getElementById('receivedGifts');
        
        if (response.success && response.data.gifts.length > 0) {
            const giftsHTML = response.data.gifts.map(gift => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-gift text-warning fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">From ${gift.sender_name}</div>
                                <div class="text-muted">${gift.amount} ${gift.currency_type}</div>
                                ${gift.message ? `<small class="text-muted">"${gift.message}"</small>` : ''}
                            </div>
                            <div>
                                <small class="text-muted">${window.utils.formatRelativeTime(gift.sent_at)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = giftsHTML;
        } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-gift text-muted mb-3"></i>
                    <div class="text-muted">No gifts received yet</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load received gifts:', error);
    }
}

async function loadUserStatus() {
    try {
        const user = window.auth.getUser();
        if (user) {
            document.getElementById('userStatusName').textContent = user.display_name || user.username;
            document.getElementById('currentStatus').textContent = user.status_message || 'Ready to game!';
            document.getElementById('currentMood').textContent = user.current_mood || 'HAPPY';
            
            if (user.avatar_url) {
                document.getElementById('userStatusAvatar').src = user.avatar_url;
            }
        }
    } catch (error) {
        console.error('Failed to load user status:', error);
    }
}

function populateGiftRecipients() {
    const select = document.getElementById('giftRecipient');
    const options = friendsData.map(friend => 
        `<option value="${friend.id}">${friend.display_name || friend.username}</option>`
    ).join('');
    
    select.innerHTML = '<option value="">Choose a friend...</option>' + options;
}

// Action Functions
function showAddFriend() {
    const modal = new bootstrap.Modal(document.getElementById('addFriendModal'));
    modal.show();
}

async function sendFriendRequest() {
    const username = document.getElementById('friendUsername').value.trim();
    if (!username) {
        showAlert('Please enter a username', 'warning');
        return;
    }
    
    try {
        const response = await apiClient.social.sendFriendRequest(username);
        if (response.success) {
            showAlert(`Friend request sent to ${username}!`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addFriendModal')).hide();
            document.getElementById('friendUsername').value = '';
        }
    } catch (error) {
        console.error('Failed to send friend request:', error);
        showAlert('Failed to send friend request', 'danger');
    }
}

async function respondToFriendRequest(requestId, action) {
    try {
        const response = await apiClient.social.respondToFriendRequest(requestId, action);
        if (response.success) {
            showAlert(`Friend request ${action.toLowerCase()}ed!`, 'success');
            loadFriendRequests();
            if (action === 'ACCEPT') {
                loadFriends();
                loadSocialStats();
            }
        }
    } catch (error) {
        console.error('Failed to respond to friend request:', error);
        showAlert('Failed to respond to friend request', 'danger');
    }
}

async function removeFriend(friendId) {
    if (!confirm('Are you sure you want to remove this friend?')) return;
    
    try {
        const response = await apiClient.social.removeFriend(friendId);
        if (response.success) {
            showAlert('Friend removed successfully', 'success');
            loadFriends();
            loadSocialStats();
        }
    } catch (error) {
        console.error('Failed to remove friend:', error);
        showAlert('Failed to remove friend', 'danger');
    }
}

function updateStatus() {
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
    
    // Pre-populate with current status
    const currentStatus = document.getElementById('currentStatus').textContent;
    const currentMood = document.getElementById('currentMood').textContent;
    
    document.getElementById('statusMessage').value = currentStatus === 'Ready to game!' ? '' : currentStatus;
    document.getElementById('statusMood').value = currentMood;
}

async function saveStatus() {
    const status = document.getElementById('statusMessage').value.trim();
    const mood = document.getElementById('statusMood').value;
    
    if (!status) {
        showAlert('Please enter a status message', 'warning');
        return;
    }
    
    try {
        const response = await apiClient.social.updateStatus(status, mood);
        if (response.success) {
            showAlert('Status updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
            loadUserStatus();
            loadActivityFeed();
        }
    } catch (error) {
        console.error('Failed to update status:', error);
        showAlert('Failed to update status', 'danger');
    }
}

async function submitGift() {
    const recipientId = document.getElementById('giftRecipient').value;
    const giftType = document.getElementById('giftType').value;
    const amount = parseFloat(document.getElementById('giftAmount').value);
    const message = document.getElementById('giftMessage').value.trim();
    
    if (!recipientId || !amount || amount < 10 || amount > 1000) {
        showAlert('Please fill in all required fields with valid values', 'warning');
        return;
    }
    
    try {
        const response = await apiClient.social.sendGift({
            friend_id: recipientId,
            currency_type: giftType,
            amount: amount,
            message: message || null
        });
        
        if (response.success) {
            showAlert('Gift sent successfully!', 'success');
            document.getElementById('sendGiftForm').reset();
            loadReceivedGifts();
        }
    } catch (error) {
        console.error('Failed to send gift:', error);
        showAlert('Failed to send gift', 'danger');
    }
}

function filterFriends() {
    const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
    const filter = document.getElementById('friendFilter').value;
    
    let filteredFriends = friendsData;
    
    if (searchTerm) {
        filteredFriends = filteredFriends.filter(friend => 
            (friend.display_name || friend.username).toLowerCase().includes(searchTerm)
        );
    }
    
    if (filter === 'online') {
        filteredFriends = filteredFriends.filter(friend => friend.is_online);
    } else if (filter === 'recently_active') {
        // Filter friends active in last 24 hours
        const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        filteredFriends = filteredFriends.filter(friend => 
            new Date(friend.last_active) > dayAgo
        );
    }
    
    displayFriends(filteredFriends);
}

async function showMyRank() {
    try {
        const response = await apiClient.social.getMyRank(currentLeaderboardType);
        if (response.success) {
            showAlert(`Your rank: #${response.data.rank} out of ${response.data.total_users} players`, 'info');
        }
    } catch (error) {
        console.error('Failed to get user rank:', error);
        showAlert('Failed to get your rank', 'danger');
    }
}

// Utility Functions
function refreshActivityFeed() {
    loadActivityFeed();
}

function refreshLeaderboard() {
    loadLeaderboard();
}

function sendMessage(friendId) {
    showAlert('Messaging feature coming soon!', 'info');
}

function sendGiftToFriend(friendId) {
    // Switch to gifts tab and pre-select friend
    const giftsTab = new bootstrap.Tab(document.getElementById('gifts-tab'));
    giftsTab.show();
    
    setTimeout(() => {
        document.getElementById('giftRecipient').value = friendId;
    }, 100);
}

function sendGift() {
    const giftsTab = new bootstrap.Tab(document.getElementById('gifts-tab'));
    giftsTab.show();
}

function shareAchievement() {
    showAlert('Achievement sharing coming soon!', 'info');
}
</script>

<style>
.friend-status.online {
    color: var(--bs-success) !important;
}

.friend-status.offline {
    color: var(--bs-muted) !important;
}

.activity-item {
    transition: background-color 0.3s ease;
}

.activity-item:hover {
    background-color: var(--bs-light);
}

.leaderboard-rank.first {
    color: #ffd700;
    font-size: 1.2rem;
}

.leaderboard-rank.second {
    color: #c0c0c0;
    font-size: 1.1rem;
}

.leaderboard-rank.third {
    color: #cd7f32;
    font-size: 1.05rem;
}

.tab-content {
    min-height: 500px;
}

.btn-group .btn {
    border-radius: 50% !important;
    width: 35px;
    height: 35px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}
